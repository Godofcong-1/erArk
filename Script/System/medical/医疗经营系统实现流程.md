# 医疗经营系统实现流程

> 本流程用于将 `Script/System/medical/医疗经营系统.md` 的方案落地为实际代码。每个步骤以待办清单形式呈现，完成后请把对应的 `[ ]` 改为 `[x]` ，再继续下一项。

## 0. 准备与基线确认
- [ ] **0.1 运行基线**：`python buildconfig.py` → `python game.py`，确认当前医疗逻辑仍沿用旧版收入结算且无新增字段。
- [ ] **0.2 代码定位**：熟悉以下文件/目录，确保 IDE/调试器可快速打开：
  - `buildconfig.py`、`Script/Config/config_def.py`
  - `Script/Core/cache_control.py`、`Script/Core/game_init.py`
  - `Script/Design/character_behavior.py`、`Script/Design/settle_behavior.py`
  - `Script/System/medical/`（新建模块）、`Script/UI/Panel/manage_*`
- [ ] **0.3 CSV 校验**：检查 `/data/csv/Medical*.csv` 是否与文档字段一致；缺列时先补 CSV，暂不改代码。

## 1. 数据与配置生成
- [ ] **1.1 BodySystem 数据**：
  - 在 `/data/csv/MedicalBodySystem.csv` 填充 8 大系统 50 部位。
  - `buildconfig.py` 新增 `load_medical_body_system()`，输出 `config_medical_body_system` 与按 `system_id/part_id` 的索引。
  - `config_def.py` 自动生成对应数据类（运行 buildconfig 验证）。
- [ ] **1.2 并发症细节结构**：
  - 扩展 `load_medical_complication()`，生成 `config_medical_complication_detail`（嵌套结构含系统/部位/等级）。
  - 为关键字段添加合法性检查（数量配额、性别限制）。
- [ ] **1.3 病情等级/医院等级/收费配置**：梳理 `MedicalSeverity/MedicalHospitalLevel/MedicalPriceConfig` 的枚举、索引器与便捷结构（如按等级 ID 的 dataclass）。
- [ ] **1.4 常量与枚举**：若需要新增资源/指令 ID，在相关 CSV（如 `ConstantEffect`, `WorkType`）或 `Script/Config/game_config.py` 中补足，确保后续引用有源。

## 2. 运行时缓存与初始化
- [ ] **2.1 Cache 字段**：在 `Script/Core/cache_control.py` 的 `Rhodes_Island` 对象上新增：
  - `medical_patients_today`, `medical_hospitalized`, `medical_price_ratio`, `medical_bed_limit`
  - `medical_inventory_accumulator`, `medical_surgery_records`, `cure_income` 拆分字段等
- [ ] **2.2 初始化**：
  - `Script/Core/game_init.py` 增加 `init_medical_department_data()`，初始化床位、价格、首批病人。
  - 老存档兼容：在 `save_handle` 读档时若字段缺失则补默认值。
- [ ] **2.3 全局常量**：根据需要在 `Script/Config/game_config.py` 或新模块中定义医疗相关常量（状态字符串、资源 ID 映射）。

## 3. 医疗核心服务模块
- [ ] **3.1 建立 `medical_service.py`**：位于 `Script/System/medical/`，负责：
  - 病人对象结构（可用 dataclass）
  - 刷新、诊疗进度推进、药物扣除、入院、手术标记等 API
- [ ] **3.2 病人刷新**：实现 `refresh_medical_patients(level:int)`，流程符合文档中系统/部位/权重要求，写入 `cache.rhodes_island.medical_patients_today`。
- [ ] **3.3 诊疗推进**：提供 `advance_diagnose(patient_id, doctor_character)`，根据医疗能力（ID 46）叠加 `diagnose_progress`，完成后转 `waiting_medication`、累积 `cure_income`。
- [ ] **3.4 药物扣除**：实现 `try_consume_medicine(patient)` 与全局 `medical_inventory_accumulator`，按资源 21~24 逐次扣库 → 记录收入或失败结果。
- [ ] **3.5 入院/住院逻辑**：
  - `try_hospitalize(patient)` 判断床位 → `medical_hospitalized`。
  - 每日调用的 `process_hospitalized_patients()` 处理降档、出院、统计。
- [ ] **3.6 手术流程支撑**：
  - 管理 `need_surgery` 队列、`surgery_blocked` 状态。
  - 提供 `attempt_surgery(patient, doctor)`，负责检查前置条件、资源扣除、收益回写。

## 4. 行为系统与 AI 接入
- [ ] **4.1 WorkType 扩展**：在 `data/csv/WorkType.csv` 增加 CID 62 “住院医生”，配置自动行为。
- [ ] **4.2 指令/行为**：
  - 更新 `Script/Design/character_behavior.py`：
    - `cure_patient` → 调用新 `medical_service` API。
    - 新增 `ward_round`/`perform_surgery` 行为（必要时新增状态机 ID）。
  - `Script/Design/settle_behavior.py`/`constant_effect.py` 处理对应结算。
- [ ] **4.3 前提/事件**：若需要新的 `judge` 或 `trigger`，在 `Script/Design/premise`、`event` 模块补充。
- [ ] **4.4 NPC 调度**：`manage_basement_panel.change_npc_work_out`、AI 排班逻辑需支持批量派遣 61/62 号医生，并与 Cache 联动。

## 5. UI 面板体系
### 5.1 医疗部总面板 `medical_department_panel.py`
- [ ] 主入口：在 `Script/UI/Panel/manage_basement_panel.py` 或导航面板添加按钮。
- [ ] **子面板结构**：实现文档描述的 5 个子页：
  1. 医生管理（显示人数、能力、接诊策略）
  2. 收费设置（ratio 调节按钮 + 预测）
  3. 医疗明细（病人列表、药物进度）
  4. 手术管理（候补病人、阻塞原因、日志）
  5. 财务报表（日/累计收入与消耗）
- [ ] UI 需调 `medical_service` 数据，只通过缓存只读渲染，不直接修改核心结构。

### 5.2 玩家诊疗面板 `medical_player_diagnose_panel.py`
- [ ] 病人信息展示：年龄/种族/自述/外观指示。
- [ ] 治病提示开关：根据 `player_med_level` 逐级揭示。
- [ ] 检查方法四级菜单与次数限制；执行时写回检查结果记录。
- [ ] 诊疗方法模块 + 药品/收益预估；操作按钮三态（检查 / 开药 / 结束）。
- [ ] 关闭面板后更新对应病人状态回主流程。

## 6. 日常结算与日志
- [ ] **6.1 settle_medical_department()**：在 `Script/System/medical/medical_service` 或 `Script/Design/settlment` 中实现，`update_base_resouce_newday()` 调用，负责：
  - 日度统计（treated/hospitalized/discharged/medicine_consumed/income）
  - 调用 `log_system.append_medical_report()`（若无则新建日志接口）
  - 重置 `cure_income` 与日度计数器。
- [ ] **6.2 UI / 邮件输出**：若需要，每日把统计写入邮件或面板记录。

## 7. 测试与验收
- [ ] **7.1 单步验证**：分别测试刷新、诊疗、用药、住院、手术；必要时添加 `Script/Design/debug_panel` 按钮触发各流程。
- [ ] **7.2 回归**：确保旧医疗收入逻辑完全由新系统替代，不再触发旧字段。
- [ ] **7.3 性能**：大量病人/手术情况下观察主循环性能，必要时增加缓存或批处理。
- [ ] **7.4 文档更新**：完成实现后同步更新 `README` / 开发文档，记录使用与调试方式。

---
**备注**：
- 若中途需要新增步骤，请在相应章节插入新的 `[ ]` 条目并保持编号有序（可用 3.7、4.5 等形式）。
- 每完成一个步骤立即在版本控制中提交或记录，方便回溯与评审。