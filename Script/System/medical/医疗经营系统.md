# 医疗经营系统

## 概述
医疗经营系统围绕罗德岛医疗部的日常运营，负责刷新源石病病人、安排干员诊治、计算药物消耗与各类收入，并维护入院病人的住院流程。该系统替换原有的医疗收入结算逻辑，为后续扩展多科室、药物链路与医疗事件提供统一入口。

## 概念与约定
- **源石病人**：所有病人均为感染源石病的个体，同时可能携带多种并发症。病人刷新时会生成一份症状档案，病情等级与并发症组合共同决定诊疗耗时、药物需求与收益。
- **病情等级**：至少四档（建议 0~3 表示轻→重），遵循"轻症多、重症少"的分布权重。例如 `轻症:0.46 / 中度:0.30 / 重度:0.18 / 危重:0.06`，可根据医疗部等级或事件动态调整。
- **医疗能力**：干员能力 ID==46；诊治时以 `(基础耗时 ÷ (1 + 能力加成))` 计算效率。
- **坐诊医生**：职业类型 ID==61 的干员才可参与诊治流程，其他干员转入辅助逻辑（后续扩展可用）。
- **药物资源**：
  - 资源 21：普通药物（主要处理并发症）
  - 资源 22~24：源石病特效药，严重病情需要更多种类与更大剂量
- **收费系数**：玩家可设置 `medical_price_ratio`（默认 1.0）。影响病人刷新量、诊疗收入与药物结算收益。
- **收入字段**：所有诊疗收入累加至 `cure_income`，供每日医疗区结算统一输出。
- **药物扣除缓存**：所有病人共享 `medical_inventory_accumulator`，按资源 ID 累加小数进度，当值 ≥1 时才扣库存。
- **床位上限**：`medical_bed_limit` 记录基础床位与住院医生加成后的可用数量。
- **医生分工**：坐诊医生（CID 61）负责门诊诊断，住院医生（CID 62）驻守病房并提升床位与康复效率。
- **患者性别**：医疗经营系统当前仅面向女性患者，所有 `MedicalBodySystem`/`MedicalComplication` 数据需保证 `gender_limit` 仅出现 0（女性专属）或 2（通用），杜绝男性限定条目。

## 人体部位数据库
为医疗经营系统新增的 `/data/csv/MedicalBodySystem.csv` 提供数据蓝本，按生理系统（Option A）组织体表与体内部位，共 8 大系统、50 个部位。`part_type=0` 表示体表、`part_type=1` 表示体内；若需性别限制则在 CSV 中以 `gender_limit` 字段标注。

## 并发症数据库结构
并发症数据仍落盘于 `/data/csv/MedicalComplication.csv`，但每条记录需关联 `system_id + part_id + severity_level`，并遵守“每部位轻症 3 种 / 中症 2 种 / 重症 1 种”的配额。字段扩展如下：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `complication_id` | int | 全局唯一 ID，建议 `system_id * 1000 + part_id * 10 + severity序号` |
| `system_id` | int | 对应 `MedicalBodySystem` 的系统 ID |
| `part_id` | int | 对应具体部位 |
| `severity_level` | int | 0=轻、1=中、2=重（危重继承 2 并附加标记） |
| `name` | str | 并发症命名 |
| `weight` | float | 该并发症在同部位同等级下的出现权重 |
| `normal_medicine_bonus` | float | 叠加到资源 21 的基础需求 |
| `appearance_indicator` | str | 外观表征（描述体表变化或“无可见异常”） |
| `patient_statement_clear` | str | 清晰自述；包含定位、程度与伴随症状 |
| `patient_statement_vague` | str | 模糊自述；包含概括性、夸大或迁移描述 |
| `exam_method` | str | 常用检查方法（视触诊、影像、体液等） |
| `exam_result_positive` | str | 检查确认有病时的详尽结果 |
| `exam_result_negative` | str | 检查确认健康的详尽结果 |
| `recheck_hint_mild` | str | 检查未能确认、但发现该部位有其他轻症 |
| `recheck_hint_moderate` | str | 检查未能确认、但发现该部位有其他中症 |
| `recheck_hint_severe` | str | 检查未能确认、但发现该部位有其他重症 |
| `treatment_plan` | str | 诊断成立后的标准治疗流程 |
| `requires_surgery` | int | 0=否、1=是；重症固定为 1，并驱动手术状态机 |

填表规则：
- 每部位轻症 3 条、中症 2 条、重症 1 条，且同一部位内各并发症 `name` 不得重复。
- 各描述符合并发症本身情况，符合实际医学中的对应专业知识。
- 外观表征需结合 `MedicalBodySystem.part_type` 撰写，为医生第一次见到患者时的患者的外观状态，所以仅包括肉眼和诊室里的基础设备能发现的外观特征，不涉及需要详细精密检查或者手术检查才能发现的外观表征。
  - 对于确实存在外观表征的并发症，应具体描述该表征。
  - 对于无明显外观表征的并发症，应明确指出“无可见异常”或类似表述。
- 轻症记录必须声明“无可见异常”或“难以肉眼察觉”类表征，治疗方案以门诊、理疗或对症药物为主。
- 中症可在体表部位提供肉眼可见表现；体内部位仍以成像/内镜所见描述，治疗方案包含联合用药或短期留观。
- 重症需描述明显可见或仪器可视化的异常（即便部位为体内），`treatment_plan` 中需包含手术步骤以及术前药物准备，`requires_surgery` 必须为 1。
- 同一部位的自述需互补：清晰自述明确指出疼痛/不适位置与程度，包含定位、程度与伴随症状；模糊自述可扩大范围或夸大强度，为 AI 行为生成多样台词。
- 检查方法为常规医学里对于检查该部位是否有该类病症的常用检查方法，包括视触诊、体液检查、专门的检查仪器等。
- 检查未能确认时，表明当前检查方法没有直接检查出当前并发症，但该检查方法却检查出当前部位有其他异常，可能为：
  - 当前部位有其他异常且病症程度等于轻症
  - 当前部位有其他异常且病症程度等于中症
  - 当前部位有其他异常且病症程度等于重症
- 各类检查结果均需围绕 `exam_method` 撰写，使 UI 能原地展示“确诊/健康/需换检”的各种提示；未确诊时 `surgery_blocked` 应保持 True。
- CSV 更新后必须执行 `python buildconfig.py`，以生成 `config_medical_complication_detail`（可在 `config_def.py` 中新增数据类）供 `medical_service` 读取。

## 核心数据结构
### 1. 病人信息（运行时缓存）
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `patient_id` | int | 唯一 ID，自增生成 |
| `severity_level` | int | 病情等级，按权重随机 |
| `complications` | list[str] | 并发症标签，用于普通药物需求 |
| `diagnose_progress` | float | 诊疗进度，单位为工时 |
| `need_resources` | dict[int, float] | 药物需求，键为资源 ID，值为累积所需数量（可为小数）|
| `state` | enum | `refreshed / in_treatment / waiting_medication / hospitalized / discharged` |
| `stay_days` | int | 入院天数，辅助统计 |
| `need_surgery` | bool | 是否等待手术（仅针对重症/危重住院病人）|
| `surgery_blocked` | bool | 是否因条件不足暂缓手术 |

### 2. 配置资源
- `/data/csv/MedicalSeverity.csv`：定义每个等级的名称、诊疗基础耗时、诊疗收入基数、药物需求模板（普通药量范围、特效药组合）。
- `/data/csv/MedicalComplication.csv`：并发症列表及普通药增量权重。
- `/data/csv/MedicalHospitalLevel.csv`：医疗区等级 → 每日病人刷新基础量、入院床位上限、收费系数对刷新量的缩放下限/上限。
- `/data/csv/MedicalPriceConfig.csv`：收费系数与刷新修正/收入加成曲线（若与等级拆分管理，可合并入等级表）。
- `/data/csv/MedicalBodySystem.csv`：医疗系统专用的人体器官/部位数据库，按生理系统（Option A：如神经、呼吸、循环等）分组记录体表与体内部位，替代 `body_part_data.csv` 在该系统中的职能。列定义如下：
   - `system_id (int)`：生理系统唯一 ID，与文档中预设顺序一致。
   - `system_name (str)`：系统中文名，供 UI 分组使用。
   - `part_id (int)`：部位 ID，系统内唯一。
   - `part_name (str)`：部位名称。
   - `part_type (int)`：0=体表、1=体内，用于计算外观异常表现。
   - `gender_limit (int)`：0=仅女、1=仅男、2=通用，沿用既有约定（本系统当前仅使用 0 与 2）。
   - `organ_priority (int)`：用于并发症挑选优先级的可选权重（值越高越优先）。
   - `notes (str)`：补充说明（例如特殊观察角度/检查禁忌）。
   数据在 `buildconfig.py` 中解析为 `config_medical_body_system`，供病人刷新、并发症挂钩及 UI 面板联动使用。
- 配置在 `buildconfig.py` 中转为 `config_medical_severity` 等字典，并在 `Script/Config/config_def.py` 生成对应数据类。

### 3. 运行缓存挂载点
- `cache.rhodes_island.medical_patients_today`：当日刷新未处理病人列表。
- `cache.rhodes_island.medical_hospitalized`：在院病人队列。
- `cache.rhodes_island.medical_price_ratio`：玩家设置的收费系数。
- `cache.rhodes_island.medical_bed_limit`：当前医疗区床位上限（等级基础值 + 建筑加成 + 住院医生加成）。
- `cache.rhodes_island.medical_inventory_accumulator`：药物扣除进度缓存，键为资源 ID，值为全局累计小数。
- `cache.rhodes_island.cure_income`：医疗板块累计收入（诊疗 + 药物）。
- `cache.rhodes_island.medical_surgery_records`：记录今日已完成手术与待手术病人（供日志与状态机使用）。

## 病人刷新逻辑
1. 游戏启动时在 `init_medical_department_data()` 中初始化首批病人数量，保证面板首次打开即可展示待诊列表。
2. 每日 00:00 在 `update_base_resouce_newday()` 调用 `refresh_medical_patients()`。
3. 刷新数量计算：
   ```
   base_count = config_medical_hospital_level[level].daily_patient_base
   ratio_penalty = clamp(1.0 / medical_price_ratio, min_ratio, max_ratio)
   refresh_count = floor(base_count * ratio_penalty)
   ```
4. 每个病人随机分配病情等级、并发症与药物需求：
   - 使用 `MedicalSeverity.csv` 的权重决定 `severity_level`。
   - 按并发症表的概率附加普通药增量（叠加至资源 21 的需求）。
   - 根据等级模板生成资源 22~24 的需求，小数值叠加至 `need_resources`。
5. 新病人加入 `medical_patients_today` 列表，状态设为 `refreshed`。

## 诊治流程
1. 玩家通过医疗面板整体调整坐诊医生数量（职业 ID==61）并选择“优先重症/正常/优先轻症”接诊策略。`data/csv/WorkType.csv` 中已定义其 `auto_ai_move` 与 `auto_ai_work`，可直接接入行为循环。
2. 诊疗耗时：
   ```
   required_hours = severity_config.base_hours
   actual_speed = doctor.medical_ability (ID 46)
   progress_increment = (1 + actual_speed / ability_scale)
   ```
   可采用行为系统中的工时驱动，或在面板中逐次推进。
3. 诊疗完成：
   - 状态变为 `waiting_medication`。
   - 根据病情等级发放诊疗报酬：
     `income = severity_config.diagnose_income * medical_price_ratio`
   - 累加至 `cure_income`。

## 药物扣除与收入
1. 对 `waiting_medication` 病人调用 `try_consume_medicine(patient)`。
2. 对每种药物：
   - 将需求小数累加至全局 `medical_inventory_accumulator[resource_id]`。
   - 当累计值 ≥1 时，实际扣除仓库中相应资源并减去 1，若库存不足则消费失败并保留累计值。
3. 扣除成功的部分收入计算：
   ```
   medicine_income = resource_price[id] * consumed_units * medicine_income_ratio * medical_price_ratio
   ```
   `medicine_income_ratio` 建议在配置表中定义（重症 > 轻症）。
4. 扣除失败时：
   - 病人状态留在 `waiting_medication`。
   - 计入“未用药”数量统计。

## 入院流程
1. 对重症/危重病人，在诊疗完成后尝试转入 `hospitalized` 状态：
   - 判断当前在院人数 < `medical_bed_limit`（包含等级基础值与住院医生加成）。
   - 转入后记录 `stay_days = 0`。
   - 入院事件可触发通知或 UI 更新。
2. 未能入院的重症病人保持 `waiting_medication`，待资源补足后直接出院（收益较低）。
3. 对成功住院的重症（CID 2）与危重（CID 3）病人，追加 `need_surgery = True` 标记并进入手术候补列表。

## 住院每日结算
1. 在每日 24:00 的医疗区结算中处理：
   - `stay_days += 1`。
   - 调用 `try_consume_medicine()`，按住院药方再次扣药。
   - 成功：
     - 病情等级下降 1 档；若降至最低档以下视为治愈，进入出院流程。
     - 收入按照 `hospital_income_ratio`（高于普通病人）计算。
   - 失败：
     - 病情保持、只获得 `hospital_base_income`（权重较小）。
2. 出院：
   - 状态设为 `discharged`，从 hospitalized 队列移除。
   - 发放一次性奖励：`severity_config.discharge_bonus * medical_price_ratio`。
   - 统计“今日出院人数”。
3. 对处于暂缓手术状态的病人（`need_surgery` 为真且 `surgery_blocked` 为真）重置标记：在新一天的结算中将其 `surgery_blocked` 复位为 False，以便后续重新尝试手术。

## 手术治疗流程
1. **手术判定**：住院后被标记为 `need_surgery` 的病人需根据病情等级检测手术条件。危重病人对药物与医生等级的需求高于重症病人。
2. **资源与人员需求**：
   - 根据病情等级匹配手术药物配方，需一次性扣除指定资源。
   - 至少一名医生（坐诊或住院）医疗能力达到配置阈值方可执行。
3. **触发时机**：每当坐诊医生完成一次 `cure_patient` 行为后，系统巡检住院队列，随机抽取一名 `need_surgery` 且 `surgery_blocked` 为 False 的病人尝试执行手术。
4. **执行流程**：
   - 若药物或医生条件不足，将病人标记为 `surgery_blocked = True`，等待下一日重试。
   - 条件满足时，从符合要求的医生中随机选取一名，将其特殊标记 `SPECIAL_FLAG.SURGERY_STATUS` 置为对应阶段，并纳入手术行动链：先进入“前往手术室”状态机（ID 663），随后切换至“手术治疗”状态机（ID 323），执行 `perform_surgery` 行为。
5. **结算**：手术行为结算通过 `constant_effect` 注册的“指令_专用结算 进行手术治疗 (ID 541)` 完成，扣除药物、根据医生医疗能力降低病情等级并结算龙门币收益，同时将病人 `need_surgery=False`。
6. **日志与统计**：手术成功后记录至 `medical_surgery_records`，用于每日汇总展示。

### 住院医生工作（工作类型 ID==62）
- `WorkType.csv` 中新增 CID 62，继承医生职业基础行为，定位于住院病房治疗。
- 在 `Script/System/medical/medical_service.py` 中统计住院医生数量及其医疗能力：
  - 每位住院医生提供固定床位加成（叠加到 `medical_bed_limit`）。
  - 住院药物成功结算时，按 `1 + ability_factor * doctor_medical_ability` 为住院病人提供额外康复速度（减少所需成功次数或额外降档几率）。
- 行为系统需加入自动排班逻辑，使 61 号医生优先处理门诊，62 号医生驻守病房；UI 允许手动切换。

## 每日统计输出
在 `update_base_resouce_newday()` 中新增 `settle_medical_department()`，替换 `settle_income()` 中旧的医疗结算。
- 统计字段：
- `total_treated_patients`：今日完成诊疗的病人数量（含未成功用药）。
- `hospitalized_today`：今日转入住院的病人数。
- `discharged_today`：今日出院病人数。
- `medicine_consumed`：药物资源总消耗（按实际扣除的整数单位统计）。
- `medical_income_today`：`cure_income` 当日总额。
- 输出流程：
  1. 调用 `log_system.append_medical_report()` 记录日志。
  2. 将统计结果写入 UI 或邮件系统，提示玩家每日医疗部运营情况。
  3. 重置 `cure_income` 与日度计数器，为下一天重新计量。

## UI 与交互建议
- 统一使用 `Script/System/medical/medical_department_panel.py` 管理医疗部 UI，结构参考 `manage_power_system_panel.py`：
   - **主面板**：概览病人数量、床位占用、药物库存与收入摘要，提供进入子面板的按钮。
   - **子面板1（医生管理）**：通过整体设置坐诊医生与住院医生数量（不再逐个干员单独调整），调用 `manage_basement_panel.change_npc_work_out` 完成增减，支持“优先重症/正常/优先轻症”三种接诊顺序（默认优先重症），实时显示当前医生数量与医疗能力综合作用下的剩余病人预计全部诊疗时间。
   - **子面板2（收费设置）**：以百分比呈现收费标准（基础 100%），左右提供 `-10%/-5%/-1%` 与 `+1%/+5%/+10%` 调节按钮，下方同步展示收费变化对应的收益与病人刷新量波动预测。
   - **子面板3（医疗明细）**：显示病人列表（门诊、等待用药、住院）、药品库存与全局扣除进度缓存。
   - **子面板4（手术管理）**：列出已标记待手术的病人、所需药物与医生条件、当前阻塞原因，并允许查看手术日志。
   - **子面板5（财务报表）**：呈现今日收入、累计收入、药品消耗与未来消耗预估。
   - 每个子面板共用统一导航与返回逻辑，并支持导出日报信息。

## 与其他系统的交互
- **资源系统**：药物扣除、龙门币收入，与 `resource_handle` 中的统一接口保持一致。
- **角色行为系统**：诊疗及手术过程可纳入干员日常行为循环；在 `character_behavior.py` 中增加 `cure_patient` 与 `perform_surgery` 行为触发逻辑，协调特殊状态机。
- **事件系统**：可触发特殊医疗事件（例如药品短缺、感染暴发）影响权重或价格。
- **建筑系统**：医疗区等级可由基建或设施升级系统维护，需要同步更新床位与刷新公式。

## 扩展点
1. **个性化病人**：引入特定身份或剧情病人，影响奖励与事件。
2. **药物制造链**：与工业生产系统联动，提供药品自给或研发加成。
3. **治疗失败惩罚**：长时间缺药可导致病情恶化或声望下降。
4. **干员疲劳**：连续工作影响诊疗速度，需要排班系统。
5. **手术特效**：引入专属术式或事件，提高手术成功率或追加特殊收益。
6. **跨系统收益**：治愈知名干员触发招募或成就。

## 快速调试示例
1. 在 `config.ini` 中确认 `debug = 1`，并按需求设置 `web_draw` 以选择 Tk 或 Web 渲染模式。
2. 执行 `python buildconfig.py`，确保最新的医疗 CSV 配置被编译进 `config_def.py`。
3. 运行 `python game.py`，进入基建界面后打开“医疗部 → 医疗经营系统”面板。
4. 在“医生管理”页调节坐诊/住院医生数量并切换接诊优先策略，观察综合医生能力后的预计全部诊疗时间与病患分配的实时变化。
5. 切换到“收费设置”页使用百分比按钮（`-10%/-5%/-1%/+1%/+5%/+10%`）调整收费，确认收益与病人刷新量预测即时更新。
6. 使用“医疗明细”页追踪等待用药、住院病患与药品累计进度，必要时通过“财务报表”页核对当日收入。
7. 触发新一天（例如通过时间流逝或调用日结），检查 `settle_medical_department()` 输出的日志与 `log_system.append_medical_report()` 记录，确认药品消耗与收入归集正确。
