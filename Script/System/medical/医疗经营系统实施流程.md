# 医疗经营系统实施流程记录

> 本文档用于在实现医疗经营系统时逐项勾选与补充备注，确保所有步骤均按顺序落地。若步骤拆分为多日执行，可在备注列写明日期与负责人。

## 0. 环境与准备
- [x] 确认使用 `c:/code/era/erArk/.conda/python.exe` 作为默认解释器，必要时执行 `python --version` 验证。
- [x] 运行一次 `python buildconfig.py` 确认现有配置生成流程正常（便于对比新字段差异）。
- [x] 检查 `config.ini` 中的 `debug`、`web_draw` 配置，决定后续调试模式。
- [x] 收集已有医疗相关脚本或遗留逻辑位置，记录在备注。

-## 1. 新增/更新数据配置
- [x] 在 `data/csv/` 下建立或更新下列文件，并保持字段说明：
  - `MedicalSeverity.csv`
  - `MedicalComplication.csv`
  - `MedicalHospitalLevel.csv`
  - `MedicalPriceConfig.csv`
- [x] 更新 `data/csv/WorkType.csv`，确认职业 ID 61（坐诊医生）配置完整，新增 ID 62（住院医生）。
- [x] 如需新增资源单价或药物系数，将所需字段同步到对应资源配置 CSV（当前无需新增，已确认现有配置满足需求）。
- [x] 调整完成后运行 `python buildconfig.py`，生成最新的 `Script/Config/config_def.py` 与医疗相关字典。
- [x] 对生成结果使用 `git diff` 或文档比对，确认新字段已进入配置类，非医疗字段无意外改动。

-## 2. 运行时缓存与枚举扩展
- [x] 在 `Script/Core/game_type.py` 添加医疗患者数据类、状态枚举及相关类型注释。
- [x] 更新 `Script/Core/cache_control.py`，在 `Cache()` 结构中挂载：
  - `cache.rhodes_island.medical_patients_today`
  - `cache.rhodes_island.medical_hospitalized`
  - `cache.rhodes_island.medical_price_ratio`
  - `cache.rhodes_island.medical_bed_limit`
  - `cache.rhodes_island.medical_inventory_accumulator`
  - `cache.rhodes_island.cure_income`
- [x] 检查初始化流程（`Script/Core/game_init.py`）确保上述字段赋初始值。

-## 3. 病人刷新逻辑
- [x] 在 `Script/Design/` 下新建或扩展模块（建议 `medical_service.py`），实现 `refresh_medical_patients()`。
- [x] 在 `update_base_resouce_newday()`（`Script/Design/basement.py` 或对应模块）调用刷新方法。
- [x] 完成刷新数量公式（含收费系数惩罚）与日志输出，确保权重随机生效。
- [x] 为每位新病人填入 `need_resources`、`severity_level`、`complications` 等字段。

-## 4. 诊治流程
- [x] 在 `medical_service.py` 中实现患者分配与诊疗推进函数（例如 `handle_outpatient_treatment()`）。
- [x] 引入坐诊医生（ID 61）的能力加成计算公式 `(1 + medical_ability / scale)`，与行为循环对接。
- [x] 诊疗完成时：更新患者状态至 `waiting_medication`，并累加 `cure_income`。
- [x] 如使用行为系统自动推进，修改 `Script/Design/character_behavior.py` 增加医疗指令。

## 5. 药物扣除与收入
- [x] 实现 `try_consume_medicine(patient)`，处理 `medical_inventory_accumulator` 缓存累加。
- [x] 与资源系统统一接口对接，扣减资源并生成药物收入。
- [x] 处理库存不足的回退逻辑，记录失败统计。
- [x] 将成功用药的收入同样写入 `cure_income` 并输出日志。

## 6. 入院与住院流程
- [x] 建立转入住院函数：检测床位、更新状态与 `stay_days`。
- [x] 将住院医生（ID 62）的床位与康复加成计算整合到 `medical_bed_limit`。
- [x] 在每日结算时处理 `stay_days` 增长、再次扣药、病情降档或出院判定。
- [x] 实现重症无床位时的等待/收益降低逻辑。

## 7. 每日医疗结算
- [x] 在 `Script/Design/basement.py`（或相应日结模块）新增 `settle_medical_department()`。
- [x] 将旧医疗收益流程（若存在）从 `settle_income()` 中剥离。
- [x] 统计并输出以下指标：
  - `total_treated_patients`
  - `hospitalized_today`
  - `discharged_today`
  - `medicine_consumed`
  - `medical_income_today`
- [x] 重置日度统计与 `cure_income`，并写入日志/邮件模块（`log_system.append_medical_report()` 等）。

## 8. UI 与交互实现
- [x] 新建 `Script/UI/Panel/medical_department_panel.py`，参照 `manage_power_system_panel.py`。
- [x] 主面板：展示病人数、床位、药物库存、收入摘要。
- [x] 子面板：
  - 医生管理（坐诊/住院分配）
  - 收费设置（`medical_price_ratio` 调节与预测）
  - 医疗明细（患者队列、药品累计进度）
  - 财务报表（今日/累计收入、药品消耗）
- [x] UI 操作应调用业务逻辑接口，不直接改缓存。
- [x] 兼容 Tk 与 Web 渲染，必要时扩展 `Script/UI/Moudle/draw.py` 与 `Script/UI/web_draw_adapter.py`。

## 9. 与其他系统的交互
- [x] 验证资源扣除对 `resource_handle` 无破坏，必要时新增 API。
- [x] 同步建筑/设施升级对 `medical_bed_limit` 与刷新数量的影响。
- [x] 若与任务/成就系统联动，登记触发点。

## 10. 自动化与测试
- *按 2025-11-11 指示暂不执行，留待人工验收。*
- [ ] 编写单元/集成测试（可在 `tests/` 或 `Script/Design/` 下建立调试脚本）验证刷新、诊疗、住院流程。
- [ ] 运行 `python game.py` 进行手动检查，分别在 Tk 模式与 Web 模式确认 UI 正常。
- [ ] 记录关键测试场景：
  - 药品不足
  - 高收费系数导致刷新量下降
  - 重症住院降档与出院
  - 多名医生分工
- [ ] 保存测试日志与截图（如有）供验收。

## 11. 文档与交付
- [x] 在 `.github/prompts/数据处理工作流/` 中补充示例或使用说明（若需要）。
- [x] 回顾本实施文档，勾选完成状况并补充备注。

## 12. 模块路径与初始化补充
- [ ] 将医疗系统业务脚本统一迁移至 `Script/System/medical/medical_service.py` 与 `Script/System/medical/medical_department_panel.py`，并更新所有引用路径（含 `import` 与文档说明）。
- [ ] 在 `init_medical_department_data()` 内补充首批病人初始化逻辑，保证面板首次载入即可显示待诊队列。
- [ ] 校验 `update_base_resouce_newday()` 与其他调用点对新路径与初始化流程的兼容性。

## 13. 医生管理策略增强
- [ ] 在 `medical_department_panel.py` 中新增整体调度控制：通过调用 `manage_basement_panel.change_npc_work_out` 调整坐诊医生与住院医生数量，取消逐个干员的单独调配。
- [ ] 实现接诊优先度切换（优先重症 / 正常顺序 / 优先轻症），影响 `medical_service.py` 选取下一位病人的逻辑。
- [ ] 根据当前医生数量与医疗能力计算剩余病人预计全部诊疗时间，并在面板实时展示。

## 14. 收费系数交互优化
- [ ] 将收费设置面板改为以 100% 为基准的百分比显示，新增 `-10%/-5%/-1%` 与 `+1%/+5%/+10%` 六个调节按钮。
- [ ] 即时刷新 `medical_price_ratio` 对病人刷新数量与医疗收益的预测结果，展示在收费面板下方。
- [ ] 确认数值调整同步写入缓存与存档逻辑，避免跨日结算出现差异。

## 15. 手术治疗功能
- [ ] 在 `medical_service.py` 中为重症/危重住院病人标记 `need_surgery`，并维护手术候补列表与 `surgery_blocked` 状态。
- [ ] 定义手术药物需求与医生能力阈值（可基于病情 CID 读取配置），并在资源/医生不足时标记 `surgery_blocked`。
- [ ] 在坐诊医生完成 `cure_patient` 行为后触发手术尝试逻辑：满足条件则随机选择一名符合条件的医生来进行手术，该医生进入手术行动链。
- [ ] 在 `Script/Core/game_type.py` 的 `SPECIAL_FLAG` 中新增手术行动链标记位，控制 0/1/2 状态。分别表示不在该行动链中、要移动到手术室、要进行手术。
- [ ] 在 `Script/Core/constant/StateMachine.py` 与 `Script/StateMachine/default.py` 增加手术相关状态机：ID 663（移动至手术室）与 ID 323（执行 `perform_surgery`）。
- [ ] 在 `constant_effect.py` 注册“指令_专用结算 进行手术治疗 (541)”以扣药、调整病情与结算收益，并清除 `need_surgery`。
- [ ] 在每日医疗结算中复位 `surgery_blocked` 病人，使其次日重新尝试；同时记录手术日志数据供 UI 展示。
- [ ] 在面板中将手术管理设为子面板4，列出待手术病人、所需药物与医生条件、当前阻塞原因，并允许查看手术日志。原财务报表改为子面板5。

---

### 备注区
| 日期 | 步骤编号 | 处理人 | 进展记录 |
| ---- | -------- | ------ | -------- |
| 2025-11-11 | 0,1 | Copilot | 完成环境检查、重跑 buildconfig，确认医疗 CSV 与 WorkType 配置；记录旧诊疗逻辑位于 `Script/Settle/default.py`、`Script/Design/basement.py` 等。 |
| 2025-11-11 | 2 | Copilot | 新增医疗患者数据结构已存在，补充基建初始化，重置医疗缓存并按医疗部等级写入初始床位上限。 |
| 2025-11-11 | 3 | Copilot | 新增 `medical_service.refresh_medical_patients`，实现刷新公式与随机病患生成，接入 `update_base_resouce_newday()` 并输出每日概览。 |
| 2025-11-11 | 4 | Copilot | 引入门诊诊疗流程，维护医生-病人绑定，完成行为结算与收入同步，并更新待诊前提判定。 |
| 2025-11-11 | 5 | Copilot | 完成 `try_consume_medicine`，串联药品扣除、失败回滚与收入写入，并输出用药日志摘要。 |
| 2025-11-11 | 6,7 | Copilot | 完成住院流程与每日结算，新增 `settle_medical_department`、住院医生加成、缺床惩罚与医疗日志记录。 |
| 2025-11-11 | 8 | Copilot | 完成医疗经营系统UI面板（总览/医生管理/收费设置/医疗明细/财务报表），对接业务函数并补充收费调节与手动结算入口。 |
| 2025-11-11 | 9 | Copilot | 引入 `resource_handle` 统一扣药，新增医疗事件队列、设施升级床位同步与成就计数器，完成跨系统交互对接。 |
| 2025-11-11 | 11.1 | Copilot | 更新 README，新增医疗经营系统入口说明与维护要点。 |
| 2025-11-11 | 11.2 | Copilot | 在医疗经营系统设计文档补充调试示例，说明面板入口与日结观察方式。 |
| 2025-11-11 | 11.3 | Copilot | 核对实施清单，标注第10步跳过及第11步文档更新完成。 |
