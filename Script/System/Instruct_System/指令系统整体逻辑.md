# 指令系统整体逻辑

## 概述

指令系统是 erArk 游戏的核心交互机制，负责处理玩家对角色的所有操作指令。本文档详细说明指令系统的数据配置、指令定义、前提判断和执行结算等完整流程。

---

## 1. 核心文件结构

```
data/csv/
├── InstructConfig.csv      # 指令主配置表（核心）
├── InstructType.csv        # 指令主类型配置
├── Instruct_Sex_Type.csv   # 性爱指令子类型配置
├── Behavior_Data.csv       # 行为数据配置
└── InstructJudge.csv       # 指令判断配置

Script/
├── System/Instruct_System/
│   ├── handle_instruct.py   # 指令执行处理（核心）
│   ├── instruct_meta.py     # 指令元数据管理
│   ├── instruct_category.py # 指令分类常量
│   ├── see_instruct_panel.py # 指令面板绘制
│   └── Instruct.py          # 指令常量定义
├── Design/
│   └── handle_premise/      # 前提条件判断
├── Core/
│   └── constant/            # 全局常量定义（从此处导入指令分类常量）
└── Config/
    └── instruct_web_config.py    # Web模式指令配置
```

---

## 2. CSV 数据配置

### 2.1 InstructConfig.csv（指令主配置表）

这是指令系统最核心的配置文件，定义了所有指令的基础信息。

#### 字段说明

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `cid` | int | 指令配置ID（数字唯一标识） | 1001 |
| `instruct_id` | str | 指令字符串ID（代码引用名） | `chat` |
| `name` | str | 指令显示名称 | 聊天 |
| `instruct_type` | str | 指令主类型枚举名 | `DAILY` |
| `instruct_sub_type` | str | 指令子类型（H模式用） | `FOREPLAY` |
| `premise_set` | str | 前提条件集合，用`\|`分隔 | `HAVE_TARGET\|NOT_H` |
| `behavior_id` | str | 关联的行为ID | `CHAT` |
| `web_category` | int | Web模式指令大类 | 1 |
| `panel_id` | str | 系统面板ID（面板类指令用） | `SEE_MAP` |
| `web_major_type` | int | Web交互大类型 | 1 |
| `web_minor_type` | int | Web交互小类型 | 10 |
| `body_parts` | str | 关联身体部位，用`\|`分隔 | `chest\|mouth` |

#### 指令编号规则

```
系统类指令：1-99     (instruct_type = SYSTEM)
日常类指令：1001-1999 (instruct_type = DAILY)
工作类指令：2001-2999 (instruct_type = WORK)
娱乐类指令：3001-3999 (instruct_type = PLAY)
技艺类指令：4001-4999 (instruct_type = ARTS)
猥亵类指令：5001-5999 (instruct_type = OBSCENITY)
性爱类指令：6001-6999 (instruct_type = SEX)
```

#### 示例记录

```csv
cid,instruct_id,name,instruct_type,instruct_sub_type,premise_set,behavior_id,web_category,panel_id,web_major_type,web_minor_type,body_parts
1004,chat,聊天,DAILY,0,HAVE_TARGET|NOT_H|TIRED_LE_84|HP_G_1|NO_TARGET_OR_TARGET_CAN_COOPERATE_OR_IMPRISONMENT_1,CHAT,1,,0,0,
5014,kiss,亲吻,OBSCENITY,0,HAVE_TARGET|NOT_H|T_NORMAL_56_OR_UNCONSCIOUS_FLAG|PENIS_NOT_IN_T_MOUSE|TIRED_LE_84|HP_G_1,KISS,1,,0,1,mouth|face
6303,normal_sex,正常位,SEX,INSERT,HAVE_TARGET|T_NPC_NOT_ACTIVE_H|TARGET_IS_H|PLACE_FURNITURE_GE_1|DR_POSITION_NORMAL|PENIS_IN_T_VAGINA_OR_WOMB|TARGET_NOT_VIBRATOR_INSERTION,NORMAL_SEX,1,,2,21,vagina
```

### 2.2 InstructType.csv（指令主类型配置）

定义指令的主分类，用于面板切换按钮。

```csv
cid,name,color
0,系统,standard
1,日常,shadow_green
2,娱乐,light_french_beige
3,工作,grullo
4,技艺,light_steel_blue
5,猥亵,pale_chestnut
6,性爱,amarath_pink
```

### 2.3 Instruct_Sex_Type.csv（性爱指令子类型配置）

定义H模式下的指令子分类。

```csv
cid,name,color
0,基础,standard
1,前戏,light_pink
2,侍奉,pastel_magenta
3,药物,princess_perfume
4,道具,rose_pink
5,插入,deep_pink
6,SM,crimson
7,技艺,light_steel_blue
```

### 2.4 Behavior_Data.csv（行为数据配置）

定义指令执行后的行为数据，包括持续时间等。

```csv
cid,en_name,name,duration,trigger,tag
101,chat,聊天,5,both,日常
6303,normal_sex,正常位,10,both,性爱
```

关键字段：
- `cid`: 行为ID（与指令的behavior_id关联）
- `duration`: 行为持续时间（分钟）
- `trigger`: 触发者类型（`pl`=玩家, `npc`=NPC, `both`=双方）

---

## 3. 指令定义机制

### 3.1 add_instruct 装饰器

位于 `Script/System/Instruct_System/handle_instruct.py`，是注册指令处理函数的核心装饰器。

```python
@add_instruct(
    instruct_id="chat",           # 指令字符串ID（必须）
    instruct_type=None,           # 可选，不传则从CSV读取
    name=None,                    # 可选，不传则从CSV读取
    premise_set=None,             # 可选，不传则从CSV读取
    behavior_id=None,             # 可选，不传则从CSV读取
    sub_type=None,                # 可选，不传则从CSV读取
)
def handle_chat():
    """聊天指令的处理函数"""
    # 指令执行逻辑
    pass
```

#### 参数优先级

装饰器参数 > CSV配置 > 默认值

#### 自动推断机制

装饰器会自动从CSV配置中读取以下信息：
1. **指令类型**：从 `instruct_type` 字段映射到枚举常量
2. **显示名称**：从 `name` 字段获取
3. **前提条件**：从 `premise_set` 字段解析
4. **行为ID**：从 `behavior_id` 字段获取
5. **Web分类信息**：从 `web_category`、`web_major_type`、`web_minor_type`、`body_parts` 获取

### 3.2 类型映射

```python
INSTRUCT_TYPE_MAP = {
    "SYSTEM": constant.InstructType.SYSTEM,    # 系统类
    "DAILY": constant.InstructType.DAILY,      # 日常类
    "PLAY": constant.InstructType.PLAY,        # 娱乐类
    "WORK": constant.InstructType.WORK,        # 工作类
    "ARTS": constant.InstructType.ARTS,        # 技艺类
    "OBSCENITY": constant.InstructType.OBSCENITY,  # 猥亵类
    "SEX": constant.InstructType.SEX,          # 性爱类
}

SUB_TYPE_MAP = {
    "0": 0,
    "BASE": constant.SexInstructSubType.BASE,          # 基础
    "FOREPLAY": constant.SexInstructSubType.FOREPLAY,  # 前戏
    "WAIT_UPON": constant.SexInstructSubType.WAIT_UPON,# 侍奉
    "DRUG": constant.SexInstructSubType.DRUG,          # 药物
    "ITEM": constant.SexInstructSubType.ITEM,          # 道具
    "INSERT": constant.SexInstructSubType.INSERT,      # 插入
    "SM": constant.SexInstructSubType.SM,              # SM
    "ARTS": 7,                                          # 技艺
}
```

### 3.3 指令注册数据结构

装饰器执行后，会将指令信息注册到以下全局数据结构：

```python
constant.handle_instruct_data[instruct_id] = func        # 指令处理函数
constant.instruct_premise_data[instruct_id] = premise_set # 前提条件集合
constant.instruct_type_data[type_id].add(instruct_id)    # 类型到指令的映射
constant.behavior_id_to_instruct_id[behavior_id] = id    # 行为到指令的映射
constant.instruct_sub_type_data[instruct_id] = sub_type  # 指令子类型
constant.handle_instruct_name_data[instruct_id] = name   # 指令显示名称
constant.instruct_id_to_cid[instruct_id] = cid           # 字符串ID到数字ID
constant.cid_to_instruct_id[cid] = instruct_id           # 数字ID到字符串ID
constant.instruct_category_data[instruct_id] = category  # Web指令大类
constant.instruct_body_parts_data[instruct_id] = parts   # 关联身体部位
```

---

## 4. 前提条件系统

### 4.1 前提条件概述

每个指令可以配置多个前提条件，只有所有前提都满足时，指令才会显示给玩家。

前提条件在 `premise_set` 字段中用 `|` 分隔，例如：
```
HAVE_TARGET|NOT_H|TIRED_LE_84|HP_G_1
```

### 4.2 常用前提条件

#### 目标相关
| 前提ID | 说明 |
|--------|------|
| `HAVE_TARGET` | 有交互目标 |
| `NO_TARGET` | 没有交互目标 |
| `TARGET_IS_H` | 目标处于H状态 |
| `T_NORMAL_5_6` | 目标态度正常（5或6级） |
| `T_UNCONSCIOUS_FLAG` | 目标无意识状态 |

#### 状态相关
| 前提ID | 说明 |
|--------|------|
| `NOT_H` | 非H模式 |
| `IS_H` | H模式中 |
| `TIRED_LE_84` | 疲劳度≤84 |
| `HP_G_1` | HP>1 |
| `TIME_STOP_ON` | 时间停止中 |
| `TIME_STOP_OFF` | 时间正常流动 |

#### 位置相关
| 前提ID | 说明 |
|--------|------|
| `IN_KITCHEN` | 在厨房 |
| `IN_BATHROOM` | 在浴室 |
| `IN_DR_OFFICE` | 在博士办公室 |
| `PLACE_FURNITURE_GE_1` | 场所家具等级≥1 |

#### 道具相关
| 前提ID | 说明 |
|--------|------|
| `HAVE_PHILTER` | 持有媚药 |
| `HAVE_VIBRATOR` | 持有震动棒 |
| `HAVE_BONDAGE` | 持有捆绑道具 |

### 4.3 前提判断流程

```python
# 位于 Script/System/Instruct_System/see_instruct_panel.py
def judge_single_instruct_filter(instruct_id, now_premise_data, now_type, ...):
    """
    判断单个指令是否通过过滤
    
    参数:
    instruct_id -- 指令字符串ID
    now_premise_data -- 已缓存的前提判断结果
    now_type -- 当前指令类型
    
    返回: (是否通过, 更新后的前提缓存)
    """
    # 1. 检查指令是否被过滤
    if not cache.instruct_index_filter[instruct_id]:
        return False, now_premise_data
    
    # 2. H子类过滤检查
    if now_type == constant.InstructType.SEX:
        sub_type = constant.instruct_sub_type_data[instruct_id]
        if not cache.instruct_sex_type_filter[sub_type]:
            return False, now_premise_data
    
    # 3. 遍历所有前提条件
    for premise in constant.instruct_premise_data[instruct_id]:
        # 优先使用缓存结果
        if premise in now_premise_data:
            if not now_premise_data[premise]:
                return False, now_premise_data
        else:
            # 调用handle_premise进行判断
            result = handle_premise.handle_premise(premise, 0)
            now_premise_data[premise] = result
            if not result:
                return False, now_premise_data
    
    return True, now_premise_data
```

---

## 5. 指令执行流程

### 5.1 执行入口

```python
# 位于 Script/System/Instruct_System/handle_instruct.py
def handle_instruct(instruct: str):
    """
    处理执行指令
    
    参数:
    instruct -- 指令字符串ID
    """
    # 将指令加入处理队列
    instruct_queue.put(instruct)
    
    # 调用对应的处理函数
    if instruct in constant.instruct_premise_data:
        constant.handle_instruct_data[instruct]()
```

### 5.2 通用结算函数

```python
def chara_handle_instruct_common_settle(
    behavior_id: str,
    character_id: int = 0,
    target_character_id: int = 0,
    duration: int = 0,
    judge: str = "",
    game_update_flag: bool = False,
    force_taget_wait: bool = False,
):
    """
    角色处理指令通用结算函数
    
    参数:
    behavior_id -- 行为ID
    character_id -- 执行角色ID（默认0=玩家）
    target_character_id -- 目标角色ID
    duration -- 持续时间（0=从配置表读取）
    judge -- 判断条件字符串
    game_update_flag -- 是否强制更新游戏流程
    force_taget_wait -- 是否强制目标等待
    """
    # 1. 初始化行为开始时间
    instuct_judege.init_character_behavior_start_time(character_id, cache.game_time)
    
    # 2. 设置角色状态
    character_data.state = behavior_id
    character_data.behavior.behavior_id = behavior_id
    
    # 3. 获取行为持续时间
    if duration == 0:
        duration = game_config.config_behavior[behavior_id].duration
    character_data.behavior.duration = duration
    
    # 4. 处理目标角色
    if force_taget_wait and target_character_id != character_id:
        target_data.state = constant.CharacterStatus.STATUS_WAIT
        target_data.behavior.behavior_id = constant.Behavior.WAIT
    
    # 5. 群交结算
    group_sex_panel.group_sex_settle(character_id, target_character_id, behavior_id)
    
    # 6. 更新游戏流程（仅玩家指令）
    if character_id == 0 or game_update_flag:
        update.game_update_flow(duration)
```

### 5.3 指令处理函数示例

```python
@add_instruct(instruct_id="chat")
def handle_chat():
    """聊天指令"""
    character_data = cache.character_data[0]
    target_id = character_data.target_character_id
    
    # 执行通用结算
    chara_handle_instruct_common_settle(
        behavior_id=constant.Behavior.CHAT,
        character_id=0,
        target_character_id=target_id,
        judge=_("聊天"),
    )

@add_instruct(instruct_id="move")
def handle_move():
    """移动指令 - 打开地图面板"""
    cache.now_panel_id = constant.Panel.SEE_MAP
```

---

## 6. 指令分类系统（Web模式）

### 6.1 指令大类

定义于 `Script/System/Instruct_System/instruct_category.py`（通过 `Script/Core/constant/` 导出）：

```python
class InstructCategory:
    SYSTEM_PANEL = 0    # 系统面板类：触发后切换到特定面板
    CHARACTER = 1       # 角色交互类：直接执行的交互指令
    CHARACTER_PANEL = 2 # 角色交互面板类：触发后打开临时面板
```

### 6.2 交互类型（新系统，2026-01-22更新）

定义在 `interaction_types.py` 中：

> **重要更新**：所有类型ID已从数字改为小写英语字符串标识符。

```python
class InteractionMajorType:
    """交互大类型（按使用器官/工具分类）- 所有值均为字符串"""
    MOUTH = "mouth"    # 嘴类
    HAND = "hand"      # 手类
    SEX = "sex"        # 性爱类（2026-01-22新增）
    PENIS = "penis"    # 阴茎类
    TOOL = "tool"      # 道具类
    ARTS = "arts"      # 技艺类（2026-01-19新增）
    OTHER = "other"    # 其他

class InteractionMinorType:
    """交互小类型 - 所有值均为字符串"""
    # 嘴类
    MOUTH_TALK = "mouth_talk"     # 对话
    MOUTH_KISS = "mouth_kiss"     # 亲吻
    MOUTH_LICK = "mouth_lick"     # 舔吸
    # 手类
    HAND_TOUCH = "hand_touch"     # 抚摸
    HAND_SLAP = "hand_slap"       # 拍打
    HAND_DRESS = "hand_dress"     # 穿脱
    HAND_DAILY = "hand_daily"     # 日常（2026-01-19新增）
    HAND_PLAY = "hand_play"       # 娱乐（2026-01-19新增）
    HAND_WORK = "hand_work"       # 工作（2026-01-19新增）
    # 性爱类（2026-01-22新增）
    SEX_START_END = "sex_start_end"  # 开始与结束（邀请H、结束H等）
    SEX_BASE = "sex_base"            # 基础（H中的基础操作）
    # 阴茎类
    PENIS_RUB = "penis_rub"       # 摩擦
    PENIS_INSERT = "penis_insert"  # 插入
    # 道具类
    TOOL_DRUG = "tool_drug"     # 药物
    TOOL_ITEM = "tool_item"     # 道具
    # 技艺类（2026-01-19新增）
    ARTS_HORMONE = "arts_hormone"   # 信息素
    ARTS_XRAY = "arts_xray"         # 透视
    ARTS_HYPNOSIS = "arts_hypnosis" # 催眠
    ARTS_TIME_STOP = "arts_time_stop" # 时停
    # 其他类
    OTHER_MISC = "other_misc"  # 杂项
```

> **重要更新（2026-01-19）**：交互大类和小类的标识符已从数字改为小写英语字符串，
> 如嘴类从 `0` 改为 `"mouth"`，手对话从 `0` 改为 `"mouth_talk"`。
> 同时新增了**技艺类**（信息素、透视、催眠、时停）。
> 手类也新增了日常、娱乐、工作三个小类。
>
> **更新（2026-01-20）**：删除了"停止交互"大类，该功能不再作为独立的交互类型。
>
> **更新（2026-01-22）**：新增了**性爱类**（开始与结束、基础），位于阴茎类之前。
> 将邀请H、结束H等指令归类到"开始与结束"小类，将H中的基础操作归类到"基础"小类。

### 6.3 身体部位

```python
class BodyPart:
    HAIR = "hair"         # 头发
    FACE = "face"         # 脸部
    MOUTH = "mouth"       # 口腔
    CHEST = "chest"       # 胸部
    ARMPIT = "armpit"     # 腋部
    HAND = "hand"         # 手部
    VAGINA = "vagina"     # 小穴
    WOMB = "womb"         # 子宫
    ANUS = "anus"         # 后穴
    URETHRA = "urethra"   # 尿道
    LEG = "leg"           # 腿部
    FOOT = "foot"         # 脚部
    TAIL = "tail"         # 尾巴
    HORN = "horn"         # 兽角
    BEAST_EARS = "beast_ears"  # 兽耳
    HIP = "hip"           # 臀部（复合部位）
    # ...
```

### 6.4 无部位指令与浮现按钮（2026-01-18新增）

**概念**：某些指令不涉及具体身体部位（如"聊天"、"移动"等），其 `body_parts` 配置为空数组。

**Web模式处理**：
- 无部位指令不在角色立绘上显示按钮
- 而是在交互类型栏右侧显示"浮现按钮"
- 浮现按钮遵循交互类型筛选逻辑：只显示当前选中的大类/小类下的无部位指令

**配置示例**（InstructConfig.csv）：
```csv
cid,instruct_id,name,...,body_parts
1004,chat,聊天,...,            # body_parts为空，显示为浮现按钮
5014,kiss,亲吻,...,mouth|face  # 有部位，显示在身体部位按钮上
```

**数据结构**：
```python
# constant.instruct_body_parts_data
{
    "chat": [],           # 无部位 → 浮现按钮
    "kiss": ["mouth", "face"],  # 有部位 → 身体部位按钮
}
```

---

## 7. 缓存数据结构

### 7.1 指令过滤器

```python
# 主类型过滤器
cache.instruct_type_filter = {
    0: True,   # 系统类开启
    1: True,   # 日常类开启
    2: True,   # 娱乐类开启
    3: True,   # 工作类开启
    4: True,   # 技艺类开启
    5: False,  # 猥亵类关闭
    6: True,   # 性爱类开启
}

# H模式子类型过滤器
cache.instruct_sex_type_filter = {
    0: True,   # 基础类开启
    1: False,  # 前戏类关闭
    2: False,  # 侍奉类关闭
    # ...
}

# 单个指令过滤器
cache.instruct_index_filter = {
    "chat": True,
    "kiss": True,
    # ...
}
```

### 7.2 前提数据缓存

在指令面板绘制时，会缓存已判断过的前提结果以提高性能：

```python
now_premise_data = {
    "HAVE_TARGET": True,
    "NOT_H": True,
    "TIRED_LE_84": True,
    # ...
}
```

---

## 8. 数据流总览

```
启动流程：
CSV文件 → buildconfig.py → JSON/常量定义 → 游戏加载 → cache缓存

指令注册流程：
@add_instruct装饰器 → 读取CSV配置 → 注册到constant字典 → 可被调用

指令显示流程：
遍历指令类型 → 类型过滤 → 前提判断 → 生成可用指令列表 → 面板绘制

指令执行流程：
用户点击 → handle_instruct() → 处理函数 → 通用结算 → 状态更新 → 时间推进
```

---

## 9. 扩展指南

### 9.1 新增指令步骤

1. **添加CSV配置**
   在 `data/csv/InstructConfig.csv` 中添加新记录

2. **运行构建脚本**
   ```bash
   python buildconfig.py
   ```

3. **编写处理函数**
   在 `Script/System/Instruct_System/handle_instruct.py` 中添加：
   ```python
   @add_instruct(instruct_id="new_instruct")
   def handle_new_instruct():
       # 处理逻辑
       pass
   ```

4. **添加前提条件**（如需要）
   在 `Script/Design/handle_premise.py` 中添加新前提

### 9.2 新增前提条件

1. 在 `Script/Core/constant_promise.py` 中添加前提枚举
2. 在 `Script/Design/handle_premise.py` 中实现前提判断函数

### 9.3 注意事项

- 修改CSV后必须运行 `buildconfig.py` 重新生成配置
- 指令ID（`instruct_id`）必须全局唯一
- 数字ID（`cid`）按类型范围分配，避免冲突
- 前提条件名称必须与 `constant_promise.Premise` 中的定义匹配

---

## 10. 调试支持

### 10.1 Debug模式

开启 `cache.debug_mode` 后，所有指令将强制通过前提判断，便于测试。

### 10.2 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 指令不显示 | 前提不满足 | 开启debug模式检查 |
| KeyError | 未运行buildconfig | 重新运行构建 |
| 指令无效果 | 处理函数未注册 | 检查@add_instruct装饰器 |
