# 指令分类映射表

本文档记录了关键角色交互类指令的分类信息，用于指导 Web 模式下的交互类型选择和身体部位点击系统。

## 1. 分类系统概述（更新于 2026年1月17日）

### 1.1 指令大类（InstructCategory）— 三类分类
| 值 | 名称 | 说明 | 触发方式 |
|---|------|------|---------|
| 0 | SYSTEM_PANEL | 系统面板类 | 点击选项卡按钮 |
| 1 | CHARACTER | 角色交互类 | 选择交互类型 → 点击身体部位 |
| 2 | CHARACTER_PANEL | 角色交互面板类 | 选择交互类型 → 点击身体部位 → 打开临时面板 |

**判定规则**：
- 函数内容为 `cache.now_panel_id = xxx` 且不含 `now_panel.draw()` → `SYSTEM_PANEL`
- 函数内容带有 `now_panel.draw()` → `CHARACTER_PANEL`
- 其他角色交互 → `CHARACTER`

### 1.2 交互类型（新系统 - 大类/小类嵌套）

**更新于 2026年1月17日**：交互类型现在采用大类/小类嵌套结构，数据从统一的 `data/csv/InstructConfig.csv` 读取。

> **注意**：原 `data/csv/InstructWebConfig.csv` 已废弃并删除，所有配置统一使用 `InstructConfig.csv`。

#### 1.2.1 大类型（InteractionMajorType）
| 值 | 常量 | 中文名 | 说明 |
|---|------|--------|------|
| 0 | MOUTH | 嘴 | 使用口腔进行的交互 |
| 1 | HAND | 手 | 使用手进行的交互 |
| 2 | PENIS | 阴茎 | 使用阴茎进行的交互 |
| 3 | TOOL | 道具 | 使用道具/药物进行的交互 |
| 4 | OTHER | 其他 | 不属于上述类别的交互 |

#### 1.2.2 小类型（InteractionMinorType）
| 值 | 常量 | 中文名 | 所属大类 |
|---|------|--------|---------|
| 0 | MOUTH_TALK | 对话 | 嘴 |
| 1 | MOUTH_KISS | 亲吻 | 嘴 |
| 2 | MOUTH_LICK | 舔吸 | 嘴 |
| 10 | HAND_TOUCH | 抚摸 | 手 |
| 11 | HAND_SLAP | 拍打 | 手 |
| 12 | HAND_DRESS | 穿脱 | 手 |
| 20 | PENIS_RUB | 摩擦 | 阴茎 |
| 21 | PENIS_INSERT | 插入 | 阴茎 |
| 30 | TOOL_DRUG | 药物 | 道具 |
| 31 | TOOL_ITEM | 道具 | 道具 |
| 40 | OTHER_MISC | 杂项 | 其他 |

#### 1.2.3 大类切换记忆机制
- 玩家切换大类时，系统会记住当前大类已选择的小类ID
- 切换到新大类时，自动恢复该大类上次选择的小类（如果有）
- 记忆存储在 `cache.web_major_type_memory` 列表中

#### 1.2.4 道具大类特殊处理
- 药物小类：点击后显示药物下拉菜单
- 道具小类：点击后显示道具下拉菜单
- 选择后，当前选中项显示在小类按钮下方

### 1.3 数据存储

交互类型数据存储在 constant 模块：
- `constant.instruct_major_type_data` - 指令ID → 大类型
- `constant.instruct_minor_type_data` - 指令ID → 小类型
- `constant.instruct_body_parts_data` - 指令ID → 身体部位列表

配置方式：在 InstructConfig.csv 中设置 `web_major_type`、`web_minor_type`、`body_parts` 字段。

### 1.4 身体部位（BodyPart）— 基于BodyPart.csv
| CSV ID | 常量 | 中文名 | COCO关键点/计算方式 |
|--------|------|--------|---------------------|
| 0 | HAIR | 头发 | 计算：头顶上方 |
| 1 | FACE | 脸部 | COCO: 0(鼻子)、1(左眼)、2(右眼) |
| 2 | MOUTH | 口腔 | 计算：鼻子下方 |
| 3 | CHEST | 胸部 | 计算：双肩(5,6)中点 |
| 4 | ARMPIT | 腋部 | 计算：肩部下方 |
| 5 | HAND | 手部 | COCO: 9(左手腕)、10(右手腕) 合并 |
| 6 | VAGINA | 小穴 | 臀部子部位 |
| 7 | WOMB | 子宫 | 臀部子部位 |
| 8 | ANUS | 后穴 | 臀部子部位 |
| 9 | URETHRA | 尿道 | 臀部子部位 |
| 10 | LEG | 腿部 | COCO: 13(左膝)、14(右膝) 合并 |
| 11 | FOOT | 脚部 | COCO: 15(左脚踝)、16(右脚踝) 合并 |
| 12 | TAIL | 尾巴 | 臀部子部位 |
| 13 | HORN | 兽角 | 计算：耳朵上方 |
| 14 | BEAST_EARS | 兽耳 | COCO: 3(左耳)、4(右耳) 合并 |
| 15 | STOMACH | 胃部 | 计算：胸部与腹部之间 |
| 16 | CROTCH | 胯部 | COCO: 11(左胯)、12(右胯) 合并 |
| 17 | BELLY | 腹部 | 计算：胯部上方 |
| 18 | BACK | 背部 | 计算：双肩中点后方 |
| - | HEAD | 头部 | 计算：鼻子正上方（虚拟） |
| - | HIP | 臀部 | 计算：双胯中点（复合，点击展开5个子部位） |

**臀部子部位展开**：点击臀部时展开 小穴、子宫、后穴、尿道、尾巴

---

## 2. OBSCENITY 类指令分类（猥亵类）

### 2.1 接触类（TOUCH）— 合并原抚摸+性触摸
| 指令名 | 关联部位 | 单部位 |
|--------|----------|--------|
| 摸头 | head | 是 |
| 摸胸 | chest | 是 |
| 摸屁股 | hip | 是 |
| 摸耳朵 | beast_ears | 是 |
| 摸角 | horn | 是 |
| 摸尾巴 | tail | 是 |
| 摸光环 | head | 是 |
| 摸翅膀 | back | 是 |
| 摸触手 | - | 否 |
| 摸小车 | - | 否 |

### 2.2 口部类（ORAL）— 合并原亲吻+口交
| 指令名 | 关联部位 | 单部位 |
|--------|----------|--------|
| 亲吻 | mouth, face | 否 |

### 2.3 其他交互（OTHER）
| 指令名 | 关联部位 | 单部位 |
|--------|----------|--------|
| 拥抱 | - | 否 |
| 牵手 | hand | 是 |
| 膝枕 | leg | 是 |
| 背后拥抱 | back | 否 |
| 公主抱 | - | 否 |

---

## 3. SEX 类指令分类（性爱类）

### 3.1 接触类（TOUCH）— 包含前戏性触摸
| 指令名 | 关联部位 | 单部位 | sub_type |
|--------|----------|--------|----------|
| 身体爱抚 | - | 否 | FOREPLAY |
| 胸爱抚 | chest | 是 | FOREPLAY |
| 玩弄乳头 | chest | 是 | FOREPLAY |
| 阴蒂爱抚 | vagina | 是 | FOREPLAY |
| 掰开阴唇观察 | vagina | 是 | FOREPLAY |
| 掰开肛门观察 | anus | 是 | FOREPLAY |
| 体外子宫按摩 | belly, womb | 否 | FOREPLAY |

### 3.2 口部类（ORAL）— 包含接吻
| 指令名 | 关联部位 | 单部位 | sub_type |
|--------|----------|--------|----------|
| 接吻 | mouth | 是 | FOREPLAY |
| 舔吸乳头 | chest | 是 | FOREPLAY |
| 舔阴 | vagina | 是 | FOREPLAY |
| 舔肛 | anus | 是 | FOREPLAY |

### 3.3 插入类（INSERT）
| 指令名 | 关联部位 | 单部位 | sub_type |
|--------|----------|--------|----------|
| 手指插入(V) | vagina | 是 | FOREPLAY |
| 手指插入(A) | anus | 是 | FOREPLAY |
| 尿道指姦 | urethra | 是 | FOREPLAY |
| 正常位 | vagina | 是 | INSERT |
| 后背位 | vagina | 是 | INSERT |
| 骑乘位 | vagina | 是 | INSERT |
| 站立位 | vagina | 是 | INSERT |
| 侧入位 | vagina | 是 | INSERT |
| 肛交 | anus | 是 | INSERT |
| 尿道插入 | urethra | 是 | INSERT |

### 3.4 侍奉类（SERVICE）
| 指令名 | 关联部位 | 单部位 | sub_type |
|--------|----------|--------|----------|
| 命令对方自慰 | - | 否 | FOREPLAY |
| 命令对方舔肛 | anus | 是 | FOREPLAY |
| 口交 | mouth | 是 | WAIT_UPON |
| 手交 | hand | 是 | WAIT_UPON |
| 脚交 | foot | 是 | WAIT_UPON |
| 腋交 | armpit | 是 | WAIT_UPON |
| 乳交 | chest | 是 | WAIT_UPON |
| 股间 | leg | 是 | WAIT_UPON |

### 3.5 道具类（ITEM）— 从特殊拆分
| 指令名 | 关联部位 | 单部位 | sub_type |
|--------|----------|--------|----------|
| 使用道具 | - | 否 | ITEM |
| 灌肠 | anus | 是 | ITEM |
| 插入跳蛋 | vagina, anus | 否 | ITEM |

### 3.6 药物类（DRUG）— 从特殊拆分
| 指令名 | 关联部位 | 单部位 | sub_type |
|--------|----------|--------|----------|
| 使用药物 | - | 否 | DRUG |

---

## 4. 自动推断规则（更新于 2026年1月17日）

当前 `add_instruct()` 装饰器已实现以下三类分类自动推断逻辑：

```python
import inspect
import re

# 自动推断指令大类（三类分类）
if category is None:
    # 尝试分析函数源代码
    try:
        source = inspect.getsource(func)
        # 检查是否包含 cache.now_panel_id = xxx（系统面板类）
        if re.search(r'cache\.now_panel_id\s*=\s*(\d+)', source):
            if not re.search(r'now_panel\.draw\s*\(', source):
                actual_category = InstructCategory.SYSTEM_PANEL
                # 自动提取 panel_id
                match = re.search(r'cache\.now_panel_id\s*=\s*(\d+)', source)
                if match:
                    panel_id = int(match.group(1))
        # 检查是否包含 now_panel.draw()（角色交互面板类）
        elif re.search(r'now_panel\.draw\s*\(', source):
            actual_category = InstructCategory.CHARACTER_PANEL
    except:
        pass
    
    # 回退到基于 instruct_type 的推断
    if actual_category is None:
        if instruct_type == constant.InstructType.SYSTEM:
            actual_category = InstructCategory.SYSTEM_PANEL
        elif instruct_type in (InstructType.OBSCENITY, InstructType.SEX):
            actual_category = InstructCategory.CHARACTER
        else:
            actual_category = InstructCategory.CHARACTER
```

## 5. 手动补充指南

对于需要精确分类的关键指令，应在 `add_instruct()` 调用时添加以下参数：

```python
@add_instruct(
    constant.Instruct.TOUCH_BREAST,
    constant.InstructType.OBSCENITY,
    _("摸胸"),
    {...前提集合...},
    constant.Behavior.TOUCH_BREAST,
    # 新增的Web模式分类参数（通过CSV配置）：
    # - web_category: InstructCategory.CHARACTER (1)
    # - web_major_type: InteractionMajorType.HAND (1)
    # - web_minor_type: InteractionMinorType.HAND_TOUCH (10)
    # - body_parts: "chest"
    # 注：single_part 已移除，改用 InstructMeta.is_single_part 属性
    # 当 body_parts 长度为1时自动判断为单部位交互
)
```

## 6. 配置方式

指令的 Web 模式分类信息通过 `InstructConfig.csv` 配置：

| 字段 | 说明 | 示例 |
|------|------|------|
| `web_category` | 指令大类 | 1 (CHARACTER) |
| `web_major_type` | 交互大类型 | 1 (HAND) |
| `web_minor_type` | 交互小类型 | 10 (HAND_TOUCH) |
| `body_parts` | 关联部位 | `chest` 或 `chest\|mouth` |

配置会在 `handle_instruct.py` 的 `add_instruct` 装饰器中自动读取。

**注意**：`single_part` 参数已被移除。是否为单部位交互现在通过 `InstructMeta.is_single_part` 属性自动判断：
- 当 `body_parts` 列表长度为1时，`is_single_part` 返回 `True`
- 当 `body_parts` 列表长度不为1时（包括0或大于1），`is_single_part` 返回 `False`

---

**最后更新**：2026年1月

**数据填充状态**：✅ 已完成（2026年1月）
- 所有指令的 `web_major_type` 和 `web_minor_type` 已在 `InstructConfig.csv` 中填充完毕
- 分类原则：
  - SYSTEM/WORK/PLAY/ARTS 类指令 → OTHER (4,40)
  - 对话类 → MOUTH_TALK (0,0)
  - 抚摸/触摸类 → HAND_TOUCH (1,10)
  - 拍打/打屁股类 → HAND_SLAP (1,11)
  - 穿脱衣物类 → HAND_DRESS (1,12)
  - 亲吻类 → MOUTH_KISS (0,1)
  - 舔吸/口交类 → MOUTH_LICK (0,2)
  - 摩擦/侍奉类 → PENIS_RUB (2,20)
  - 插入/性交类 → PENIS_INSERT (2,21)
  - 药物类 → TOOL_DRUG (3,30)
  - 道具类 → TOOL_ITEM (3,31)
