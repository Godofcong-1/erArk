# erArk Web绘制模式UI重构说明文档

## 目录
1. [项目概述](#1-项目概述)
2. [画面布局设计](#2-画面布局设计)
3. [核心功能模块](#3-核心功能模块)
4. [交互系统设计](#4-交互系统设计)
5. [角色图像系统](#5-角色图像系统)
6. [演出与结算系统](#6-演出与结算系统)
7. [指令分类系统](#7-指令分类系统)
8. [素材处理流程](#8-素材处理流程)
9. [文件结构规划](#9-文件结构规划)

**最后更新**:2026年2月8日

**重要架构更新(2026-01-17)**:
- 已废弃双模板系统(`index.html` + `game_main.html`切换)
- 采用单页面应用架构:所有面板统一使用 `index.html`
- 主面板新UI通过 `new_ui_container` 元素类型在同一页面内渲染
- 详见《Web绘制模式UI重构实现流程.md》第9.3节

---

## 1. 项目概述

### 1.1 重构目标
将当前erArk游戏的web绘制模式从类似tk模式的文本式UI，重构为一个现代化、图形化、交互友好的游戏界面。

### 1.2 设计原则
- **横屏显示**：默认分辨率1920×1080（1080P）
- **主要目标设备**：台式电脑
- **流式数据传输**：仅更新变动的组件，保持流畅性
- **图形化交互**：以角色图像为核心的交互方式

### 1.3 核心变更概览

| 项目 | 原方案 (tk模式) | 新方案 (web模式) |
|------|----------------|-----------------|
| 显示方式 | 文本列表式 | 图形化界面 |
| 交互方式 | 点击指令列表 | 选择交互类型+点击角色/部位 |
| 角色显示 | 半身图列表 | 全屏背景+中央全身立绘 |
| 指令分类 | 统一指令栏 | 两类指令分区显示（面板类+角色交互类） |
| 数值反馈 | 文本输出 | 动画化数值变动 |

### 1.4 相关现有文件
- 主面板：`Script/UI/Panel/in_scene_panel.py`
- Web服务器：`Script/Core/web_server.py`
- Web流程处理：`Script/Core/flow_handle_web.py`
- Web IO：`Script/Core/io_web.py`
- 模板文件：`templates/index.html`
- 指令定义：`Script/System/Instruct_System/handle_instruct.py`
- 角色信息：`Script/UI/Panel/character_info_head.py`
- 角色状态：`Script/UI/Panel/see_character_info_panel.py`
- 角色服装：`Script/UI/Panel/cloth_panel.py`
- 角色身体：`Script/UI/Panel/dirty_panel.py`
- 群交面板：`Script/System/Sex_System/group_sex_panel.py`
- 隐奸面板：`Script/System/Sex_System/hidden_sex_panel.py`
- 角色图片下载：`tools/download_prts_character_image.py`

### 1.5 交互对象系统（2026-02-07新增）

玩家的交互对象由 `Script/Core/game_type.py` 中 `Character` 类的 `target_character_id` 属性定义。

#### 1.5.1 交互对象判断逻辑
- **有交互对象**：当 `target_character_id > 0` 时，表示玩家选择了一个NPC作为交互对象
- **无交互对象**：当 `target_character_id == 0`（等于玩家自己的cid）时，表示玩家没有交互对象
- **无效值**：当 `target_character_id < 0` 时，表示无效状态

#### 1.5.2 交互对象相关的UI元素
以下UI元素与当前交互对象相关：
| 区域 | 显示内容 | 无交互对象时 |
|------|---------|-------------|
| 正中间角色立绘区 | 交互对象的全身立绘 + 身体部位按钮 | 不显示 |
| 最右边交互对象信息区 | 交互对象的核心状态信息 | 不显示 |
| 上方中间附加信息区 | 交互对象的服装/身体/群交/隐奸信息 | 不显示 |
| 上方右边头像区 | 场景内除玩家和交互对象外的角色 | 显示场景内除玩家外的所有角色 |

#### 1.5.3 切换交互对象
- **操作方式**：点击头像区的角色头像
- **实现机制**：WebSocket `switch_target` 事件
- **刷新流程**：
  1. 前端发送 `switch_target` 事件，携带目标角色ID
  2. 后端更新 `pl_character_data.target_character_id`
  3. 后端设置刷新信号 `button_click_response = WEB_REFRESH_SIGNAL`
  4. 主循环被唤醒，进入下一次迭代
  5. 收集新的游戏状态（基于新交互对象）
  6. 推送完整状态到前端
  7. 前端重新渲染UI

---

## 2. 画面布局设计

### 2.1 整体布局（1920×1080）

```
┌─────────────────────────────────────────────────────────────────────────┐
│ [场景信息栏]                                                             │
│  当前位置:罗德岛·办公楼·博士办公室            时间:2099年 春 1日 6点0分 周一 │
├─────────────────────────────────────────────────────────────────────────┤
│ [面板选项卡栏]                                                           │
│  移动 | 存档 | 读档 | 设置 | 状态 | 属性 | 关系 | 收藏 | ...                 │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌──────────────────────┐ ┌──────────────────────────┐ ┌──────────────┐ │
│ │                      │ │ [服装栏][身体栏][群交][隐奸]│ │  [头像区]    │ │
│ │   [玩家信息区]        │ │ 交互对象的服装/身体/      │ │   ○○○    │ │
│ │                      │ │ 群交/隐奸信息             │ │    ○○ ▷   │ │
│ └──────────────────────┘ └──────────────────────────┘ └──────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                          [背景图层]                                      │
│                                                       ┌──────────────┐  │
│    ┌──────────┐                                       │[交互对象信息]│  │
│    │          │         ┌─────────────────┐           │              │  │
│    │ [交互    │         │                 │           │ 名字 好感 信赖│  │
│    │  类型栏] │         │   [角色立绘]     │           │ [体力槽][气力]│  │
│    │          │         │    (中央)       │           │ <特殊状态... > │  │
│    │ ○说话    │         │                 │           │ ─快感状态─   │  │
│    │ ○抚摸    │         │  (可点击部位    │           │ ○○○○       │  │
│    │ ○亲吻    │         │   隐形按钮)     │           │ ○○○○       │  │
│    │ ○穿脱    │         │                 │           │ ─其他状态─   │  │
│    │ ...       │         └─────────────────┘           │ ○○○○       │  │
│    └──────────┘                                       │ ○○○○       │  │
│                                                       └──────────────┘  │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │                        [对话框区域]                                  │ │
│ │  [角色名]  这是当前的一句台词描述文本，点击任意位置继续...               │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 各区域说明

#### 2.2.0 场景信息栏（最顶部）（2026-02-07 新增）
- **位置**：画面最上方，在面板选项卡栏之上，横向占满整个屏幕宽度
- **内容**：左侧显示当前场景名，右侧显示游戏时间
- **样式**：单行高度，深色背景，左右分布布局
  - 背景色：`rgba(15, 15, 25, 0.95)`
  - 上内边距：12px（让文本上方有空间，不显示为黑色）
  - 下内边距：16px（让与选项卡间有空隙，且空隙为背景色）
  - 行高：1.5（提升文本可读性）
- **数据来源**：
  - 场景名：`attr_text.get_scene_path_text()` + 门锁状态判断
  - 游戏时间：`game_time` 模块的年/月/日/时/分/星期/时段/工作日信息

**实施细节**：
- **后端实现**：`in_scene_panel_web.py` 的 `_get_scene_info_bar()` 方法
- **前端渲染**：`game.js` 的 `createSceneInfoBar()` 函数
- **CSS样式**：`.new-ui-scene-info-bar`、`.scene-info-name`（左侧，浅蓝色 #88ccff）、`.scene-info-time`（右侧，灰色 #aaa）

**样式优化说明（2026-02-07）**：
- 增加内边距确保文本周围有充足空间
- 使用 `padding` 而非 `margin` 确保空隙区域显示为背景色而非黑色
- 更大的下内边距让信息栏与选项卡有明显的视觉分隔

#### 2.2.1 面板选项卡栏（顶部）
- **位置**：画面最上方，横向占满整个屏幕宽度
- **内容**：主面板选项卡 + 所有满足条件的系统面板类指令选项卡
- **样式**：网页选项卡样式（底部边框高亮表示激活状态）
- **自适应规则**：
  - 选项卡数量较少时，每个选项卡保持固定宽度
  - 选项卡数量较多超过一排时，自动换行显示

**选项卡组成（2026-01-17 更新）**：
1. **主面板选项卡**：始终存在，默认激活，id 为 `__main_panel__`，显示名称"主面板"
2. **系统面板类选项卡**：动态获取所有满足前提条件的系统面板类指令（如移动、存档、设置等）

**选项卡样式说明**：
- 采用网页选项卡样式而非按钮样式
- 激活状态：金色底部边框（2px），加粗文字，金色文字
- 悬停状态：浅色背景，底部边框变灰色
- 禁用状态：透明度降低，鼠标禁用

**实施细节（2026-01-17 更新）**：
- **前端实现**：
  - 选项卡通过 `static/game.js` 中的 `createPanelTabsBar()` 函数创建
  - 使用 `container.insertBefore()` 插入到新UI容器的最前面
  - CSS类 `.new-ui-panel-tabs` 和 `.panel-tab-btn`，样式见 `static/style.css`
  - 支持 `.active` 激活状态和 `.main-tab` 主面板特殊样式
- **数据源**：
  - 由 `Script/UI/Panel/web_components/tab_menu.py` 的 `TabMenu.get_panel_tabs()` 提供
  - 主面板选项卡 id 为 `__main_panel__`
  - 其他选项卡 id 为指令ID（与 `constant.Instruct` 中的常量一致）
  - 选项卡数据包含：`id`, `name`, `type`, `available`, `active`
- **点击处理**：
  - 主面板激活时不响应点击
  - 其他选项卡使用 `/api/button_click` API（与普通按钮相同）
  - 后端通过 `flow_handle.bind_cmd()` 绑定指令处理函数
  - 通过 `flow_handle.askfor_all()` 等待用户选择
- **面板切换**：
  - 点击选项卡执行对应的面板类指令（如 `handle_move()`）
  - 指令设置 `cache.now_panel_id` 切换面板
  - `InScenePanelWeb.draw()` 检测到面板ID改变后退出循环

#### 2.2.2 玩家信息区（左上）
- **位置**：选项卡栏下方左侧
- **内容**：玩家角色的信息，参考 `Script/UI/Panel/character_info_head.py`
- **排版规则**：
  - **第一行**：名字按钮 + 昵称
  - **第二行**：体力槽 + 气力槽 + 理智槽 + 精液槽
  - **第三行**：特殊状态标记（2026-01-27调整）
- **玩家名字按钮**（2026-02-07新增）：
  - 玩家名字显示为可点击的按钮而非纯文本
  - 点击后执行"与自己交互"(target_to_self)指令
  - 执行后自动刷新主界面，确保交互效果立即生效
  - 按钮样式：黄色边框(#ffd700)、灰色底色(#3a3a4a)，与服装/身体按钮风格一致
  - 按钮悬停时有微弱发光效果
- **特殊状态标记**：用`<>`表示的各种状态（详见 2.3 节）
  - （2026-01-27）从名字后面移至精液槽下面单独一行显示
- **状态槽显示**：使用图片资源绘制（2026-01-27实现）
  - 体力槽：`/image/状态条/hpbar_null.png` 和 `hpbar_true.png`
  - 气力槽：`/image/状态条/mpbar_null.png` 和 `mpbar_true.png`
  - 理智槽：`/image/状态条/statbar_null.png` 和 `statbar_true.png`
  - 精液槽：`/image/状态条/spbar_null.png` 和 `spbar_true.png`
- **快速使用药剂功能**（2026-01-27新增，2026-02-07更新）
  - 理智槽标签后添加加号按钮，可快速使用理智药剂
  - 精液槽标签后添加加号按钮，可快速使用精力剂
  - 按钮仅在玩家有对应药剂时显示
  - 点击后调用 `/api/quick_use_drug` API，后端自动使用最小规格的药剂
  - **立刻刷新**（2026-01-28更新，2026-02-07更新）：
    - 后端API记录使用前数值，使用后计算变化并添加到 `cache.web_value_changes`
    - 后端API返回更新后的完整玩家信息（包括 `value_changes` 字段）
    - 前端接收后调用 `updatePlayerInfoUI()` 函数局部更新玩家信息区
    - 使用后端返回的 `value_changes` 数据显示浮动文本（不再由前端计算）
    - 无需刷新整个页面，只更新玩家信息区，用户体验更流畅
- **数值变化浮动文本**（2026-01-28新增，2026-02-07更新）
  - 参考右侧交互对象信息区的浮动文本显示逻辑
  - 玩家只显示体力、气力、理智、精液、经验的变化
  - **不显示常规状态变化**（2026-02-07新增）：
    - 不显示部位快感（皮肤、胸部、阴蒂等）变化
    - 不显示其他状态（好意、快乐、恭顺等）变化
    - 这些状态仅对交互对象显示，玩家信息区不需要
  - 浮动文本颜色：
    - 体力：红色 (#e15a5a)
    - 气力：绿色 (#70C070)
    - 理智：蓝色 (#7070C0)
    - 精液：黄色 (#fffacd)
    - 经验：春绿色 (#00ff7f)
  - 浮动文本显示格式：` +数值` 或 ` -数值`（前面有空格）
  - **浮动文本位置**（2026-02-07更新）：
    - 体力/气力/理智/精液：显示在数值后面，格式如 `100/200 +20`
    - 使用 `position-end-inline` 类，作为内联元素显示
    - 不再下移一行或使用特殊绝对定位
    - 经验值等其他变化：在特殊状态下方新开一行显示
  - 浮动文本持续时间：15秒后自动淡出消失
  - 数据来源（2026-02-07更新）：
    - 后端 `get_player_info()` 返回 `value_changes` 字段
    - 数据由 `settle_behavior.py` 的 `collect_web_value_changes()` 收集
    - 快速使用药剂时由 `/api/quick_use_drug` 直接添加到 `cache.web_value_changes`
    - 前端使用 `createPlayerFloatingValueChanges()` 处理
  - 实现方式：
    - 后端：`status_panel.py` 的 `get_player_info()` 调用 `_get_value_changes(0)` 获取玩家数值变化
    - 后端：`settle_behavior.py` 对玩家不收集状态变化（`status_data`）
    - 前端：`createPlayerInfoPanel()` 调用 `createPlayerFloatingValueChanges()` 显示浮动文本
    - 前端：`updatePlayerInfoUI()` 直接使用后端返回的 `value_changes`
    - 复用 `createInlineFloatingText()` 在状态条位置显示变化
    - 使用 `createPlayerBottomFloatingTexts()` 在底部显示其他变化
- **Web模式结算信息显示**（2026-02-03新增）
  - Web模式下不再直接打印角色数值结算信息
  - 修改 `character_behavior.py`，在Web模式下跳过 `settle_panel.draw()` 调用
  - 玩家结算信息：通过左上角玩家信息区的浮动文本显示
  - 交互对象结算信息：通过右侧交互对象信息栏的浮动文本显示
  - TK模式保持原有行为，正常绘制结算面板
- **布局优化**（2026-01-27更新）
  - 玩家姓名单独一行，与边缘保持适当距离（12px顶部内边距）
  - 姓名和体力行之间有更好的间距（12px下边距）
- **实现细节**：
  - 前端使用 `createImageStatusBar()` 函数创建状态槽
  - 带按钮的状态槽使用 `createImageStatusBarWithButton()` 函数
  - 状态条添加 `data-field` 属性用于浮动文本定位
  - CSS使用 `background-image` 属性加载图片
  - 填充部分使用 `background-repeat: repeat-x` 实现平铺
  - 特殊状态标记与右侧角色信息区使用相同的渲染逻辑
  - `.new-ui-player-info` 和 `.status-bar` 添加 `position: relative` 为浮动文本提供定位上下文
  - 玩家浮动文本容器样式：`.player-floating-container` 和 `.player-floating-text`

#### 2.2.3 交互对象附加信息区（中上）
- **位置**：选项卡栏下方中央
- **内容**：当前交互对象的附加信息，包括：
  - 服装栏：参考 `Script/UI/Panel/cloth_panel.py`
  - 身体栏：参考 `Script/UI/Panel/dirty_panel.py`
  - 群交栏：参考 `Script/System/Sex_System/group_sex_panel.py`
  - 隐奸栏：参考 `Script/System/Sex_System/hidden_sex_panel.py`
- **布局说明**：这些栏目大多为单行或多行文本信息
- **栏位按钮**：顶部显示栏位名称按钮（服装、身体、群交、隐奸），点击可展开/收起对应栏位
- **详细污浊按钮**：右侧显示"展开详细污浊"/"收起详细污浊"按钮，切换是否显示完整污浊描述
- **全部位显示按钮（2026-01-28新增）**：在详细污浊按钮左侧显示"展开全部位显示"/"收起全部位显示"按钮，控制角色立绘上的身体部位按钮是否始终显示。收起状态（默认）下部位按钮仅在鼠标悬停时显示，展开状态下所有部位按钮始终可见并带有脉冲动画
- **H模式服装交互**：在H模式下，服装名称显示为可点击按钮，点击可切换穿脱状态
- **数据刷新**：与右侧"交互对象信息区"使用相同的刷新时机，在每次指令结算后同步更新

**实施状态（2026年1月28日更新）**：✅ 已实现
- 后端数据获取：`Script/UI/Panel/web_components/status_panel.py` 中 `get_target_extra_info()` 方法
- 前端渲染：`static/game.js` 中 `createTargetExtraInfoPanel()` 及相关函数
- 后端API：`Script/Core/web_server.py` 中 `/api/toggle_extra_info_section`、`/api/toggle_detailed_dirty`、`/api/toggle_cloth`、`/api/toggle_all_body_parts`
- **栏位按钮行为**：服装和身体栏位按钮始终显示，点击立即切换展开/收起状态（前端本地更新，同时保存状态到后端）
- **布局优化**：玩家信息区使用固定宽度(200px)，附加信息区自动扩展填充剩余空间，默认高度150px与玩家信息区高度匹配
- **详细污浊按钮**：点击"展开/收起详细污浊"按钮会立即更新按钮文本，并向后端发送请求切换状态。后端返回更新后的附加信息数据，前端立即重新渲染面板以显示新的污浊文本（详细/简略版本）
- **全部位显示按钮（2026-01-28新增）**：点击按钮会立即切换按钮文本和身体部位按钮的显示状态（添加/移除 `.always-visible` 类），并向后端发送请求保存状态（`draw_setting[18]`）。该功能不影响选择交互类型后的部位高亮逻辑
- **身体污浊显示优化（2026-01-28新增）**：身体栏中每个部位的污浊信息使用 `display: inline` 显示，部位名称标签（格式：`[部位名]:`）与污浊文本在同一行内，与服装栏保持完全一致的显示风格
- **悬停延展显示（2026-01-28新增）**：默认高度150px无滚动条，鼠标悬停时向下延展至800px显示全部内容。采用嵌套容器策略：外层容器保持在flex布局中占据固定空间，内层容器悬停时使用绝对定位脱离文档流向下扩展，确保不影响左侧玩家信息区和右侧头像区的布局。延展时提高z-index覆盖其他元素，并添加阴影增强浮动效果
- **区域高度**：外层容器固定 `max-height: 150px`（与玩家信息区匹配），内层容器默认 `max-height: 134px`，悬停时 `max-height: 800px`（使用绝对定位）
- **无交互对象时不显示（2026-02-07新增）**：当玩家没有交互对象（`target_character_id == 0`）时，交互对象附加信息区整体不显示

#### 2.2.4 头像区（右上）
- **位置**：选项卡栏下方右侧
- **内容**：场景内所有角色（除玩家和当前交互对象之外）的头像
- **头像图片**：使用 `{角色名}_头部.png` 作为头像图片
- **布局规则**：
  - 单行显示，最多显示5个头像
  - 第一行前3个位置 + 第二行前2个位置共5个头像位置
  - 超过5个人时，第6个位置（即第二行第3个位置）显示为翻页按钮
- **交互（2026-02-07更新）**：点击头像可切换当前交互对象
  - 点击后更新玩家的 `target_character_id` 为该角色ID
  - 触发主界面完整刷新，相关内容跟随更新：
    - 正中间的角色立绘切换为新交互对象
    - 右侧的交互对象信息切换为新交互对象的数据
    - 上方中间的附加信息切换为新交互对象的服装/身体等信息
    - 头像区重新计算，排除新交互对象，可能新增原交互对象
  - 实现方式：WebSocket `switch_target` 事件 + 刷新信号机制
- **无交互对象时的显示（2026-02-07新增）**：
  - 当玩家没有交互对象时，头像区显示场景内除玩家外的所有角色
  - 不排除 `target_character_id = 0` 的情况（因为这表示当前没有交互对象）
- **点击角色时显示行为文本和数值变化（2026-02-07新增）**：
  - 当头像下方有待显示的小对话框文本时，点击该角色头像会：
    1. 将该角色的完整行为文本移动到下方对话框区域进行显示
    2. 刷新该角色的数值变化时间戳，确保相关浮动文本能在右侧信息栏显示
  - 实现逻辑在 `web_server.py` 的 `handle_switch_target()` 函数中
  - 从 `cache.web_minor_dialog_queue` 中移除并转移到主对话框队列
  - 刷新 `cache.web_value_changes` 中该角色数据的时间戳

#### 2.2.5 主画面区（中央）
- **位置**：画面中央主体区域
- **内容**：
  - **背景图层**：当前场景的地点图像，位于最底层
  - **角色立绘**：当前交互对象的全身立绘，居中显示
- **背景图规则**：
  - 优先查找 `image/场景/{地点名}.png`
  - 若不存在同名图片，默认使用 `image/场景/博士办公室.png`
  - 图片保持原比例扩大至整个画面，空白区域填充黑色
- **角色立绘高度缩放规则（2026-02-07新增）**：
  - 首先检查当前窗口大小导致的角色立绘可用高度上限
  - 如果可用高度 > 1024像素，将图片高度固定为 1024像素，并等比例缩放宽度
  - 如果可用高度 ≤ 1024像素，将图片高度设为可用高度上限，并等比例缩放宽度
  - 图片居中显示
  - 身体部位的点击位置随图片一起同步缩放，确保位置准确对应
  - 窗口大小改变时自动重新计算高度
- **与浮现按钮重叠处理（2026-02-07更新）**：
  - 在高度缩放后，仍会检测与左侧浮现按钮的重叠
  - 如有重叠，优先将角色图片向右平移来回避
  - 如平移后仍与右侧状态栏冲突，则进一步缩小图片
  - 移动或缩小后，身体部位的点击位置也会同步调整
- **无交互对象时（2026-02-07新增）**：
  - 角色立绘区不显示（只显示背景图层）
  - 交互类型栏仍然显示（可进行部分操作）

#### 2.2.6 交互类型栏（左侧）
- **位置**：主画面区的左侧边缘
- **内容**：角色交互类型选择面板，采用大类选项卡+小类按钮的嵌套结构
- **交互逻辑**：选择交互类型后，角色图像上会显示可交互的部位按钮

**大类/小类嵌套结构（2026-01-18 实施）**：
- **面板布局**：垂直排列的选项卡式面板
  - 上半部分：大类选项卡（从上到下排列）
  - 下半部分：当前大类下的小类按钮列表
- **大类（5个）**：嘴、手、阴茎、道具、其他
  - 通过左侧边框高亮表示当前选中的大类
  - 切换大类时会记忆并恢复上次选中的小类
- **小类按钮**：显示在选中大类下方
  - 嘴类：对话、亲吻、舔吸
  - 手类：抚摸、拍打、穿脱
  - 阴茎类：摩擦、插入
  - 道具类：药物、道具
  - 其他类：杂项
- **交互流程**：
  1. 点击大类选项卡切换大类
  2. 点击小类按钮选择具体交互方式
  3. 选中小类后，角色身上可交互的部位会高亮显示
  4. 点击高亮的部位执行对应的指令

#### 2.2.7 交互对象信息区（右侧）
- **位置**：主画面区的右侧边缘
- **内容**：当前交互对象的核心状态信息
- **参考**：`Script/UI/Panel/character_info_head.py`、`Script/UI/Panel/see_character_info_panel.py`
- **排版规则**：
  - **第一行**：角色名字 + 好感度 + 信赖度
  - **第二行**：体力槽 + 气力槽
  - **第三行**：特殊状态标记（用`<>`表示的各种状态）
  - **第四行起**：角色状态槽，每行显示4个状态
- **状态槽分块**：
  - **快感状态块**：与快感相关的状态
  - **其他状态块**：其他类型的状态
- **无交互对象时不显示（2026-02-07新增）**：当玩家没有交互对象（`target_character_id == 0`）时，交互对象信息区整体不显示

#### 2.2.8 对话框区域（底部）
- **位置**：画面最下方
- **样式**：经典文字冒险游戏/恋爱游戏的对话框风格
  - 半透明文本框背景
  - 左侧显示角色名字
  - 内部显示当前台词描述
- **交互**：
  - 左键点击任意位置推进文本
  - 按住右键或Ctrl键快速跳过

### 2.3 角色信息详细内容

根据 `Script/UI/Panel/character_info_head.py`，角色信息包含以下内容：

#### 2.3.1 基础信息
- **名字**：角色名称
- **昵称**：仅玩家显示
- **好感度**：仅NPC显示，包含数值和等级（如 `好感度:1234(A)`）
- **信赖度**：仅NPC显示，包含数值和等级（如 `信赖度:50.0%(B)`）

#### 2.3.2 数值槽
| 槽类型 | 显示对象 | 说明 |
|-------|---------|------|
| 体力槽 | 全部角色 | 体力，最低为1时会疲劳到无法行动 |
| 气力槽 | 全部角色 | 精神上的耐力，最低为0时使体力消耗增加 |
| 理智槽 | 仅玩家 | 使用源石技艺时消耗 |
| 精液槽 | 仅玩家 | 进行射精时消耗 |

#### 2.3.3 特殊状态标记
用 `<>` 符号包裹的状态标记，根据角色当前状态动态显示：

| 状态标记 | 说明 | 适用对象 |
|---------|------|---------|
| `<清醒>` / `<困倦>` 等 | 疲劳/睡眠状态 | 全部 |
| `<装睡>` | 已醒来但装睡 | NPC |
| `<累>` | 疲劳度过高 | 全部 |
| `<愉快>` / 心情不佳 | 当前心情状态 | NPC |
| `<跟>` | 智能跟随状态 | NPC |
| `<尿>` | 有较强尿意 | 全部（可设置隐藏） |
| `<饿>` | 饥饿状态 | 全部（可设置隐藏） |
| `<射精欲: 低/中/高/极>` | 射精欲望程度 | 仅玩家 |
| `<催眠(数值):类型>` | 催眠状态及类型 | 全部 |
| `<携袋: 角色名>` | 携带袋装角色 | 全部 |
| `<监>` | 被监禁状态 | NPC |
| `<访>` | 访客状态 | NPC |
| `<逆>` | 逆推H状态 | NPC |
| `<寸止>` | 绝顶寸止状态 | 全部 |
| `<停>` | 时间停止状态 | 全部 |
| `<隐>` | 隐奸状态 | 全部 |
| `<露>` | 露出状态 | 全部 |

#### 2.3.4 快感状态
根据 `data/csv/CharacterState.csv` 中状态类型0的定义，包含以下快感状态：

| 状态ID | 状态名 | 说明 | 性别限制 |
|-------|--------|------|---------|
| 0 | 皮肤 | 性器官以外的皮肤上的性快感累积值 | 无 |
| 1 | 胸部 | 胸部及乳头区域的性快感累积值 | 无 |
| 2 | 阴蒂 | 阴蒂及其周边区域的性快感累积值 | 仅女性 |
| 3 | 阴茎 | 阴茎及龟头的性快感累积值 | 仅男性 |
| 4 | 阴道 | 阴道内壁及G点区域的性快感累积值 | 仅女性 |
| 5 | 肛肠 | 肛门及直肠区域的性快感累积值 | 无 |
| 6 | 尿道 | 尿道口、尿道、膀胱的性快感累积值 | 无 |
| 7 | 子宫 | 子宫颈及子宫内壁的性快感累积值 | 仅女性 |
| 21 | 口喉 | 口腔、舌头、喉咙的性快感累积值 | 无 |
| 22 | 兽部 | 兽耳、尾巴、翅膀等兽化部位的性快感累积值 | 无 |
| 23 | 心理 | 纯心理层面的性快感累积值 | 无 |
| 8 | 润滑 | 阴道、肛肠等部位的润滑状态（归入快感块显示） | 无 |

每个快感状态显示格式：`{状态名}Lv{等级}` + 进度条 + 数值

#### 2.3.5 其他状态
根据 `data/csv/CharacterState.csv` 中状态类型1的定义：

| 状态ID | 状态名 | 说明 |
|-------|--------|------|
| 9 | 习得 | 通过学习、训练、经验累积获得的知识总量 |
| 10 | 恭顺 | 服从与顺从玩家命令的累积值 |
| 11 | 好意 | 与玩家进行亲密互动的累积值 |
| 12 | 欲情 | 性欲的高涨与性冲动的累积值 |
| 13 | 快乐 | 身心愉悦与幸福感的累积值 |
| 14 | 先导 | 在互动中掌握主导权与控制权的累积值 |
| 15 | 屈服 | 精神层面的屈服与丧失意志的累积值 |
| 16 | 羞耻 | 羞耻感与打破社会道德束缚的情绪累积值 |
| 17 | 苦痛 | 肉体痛苦的累积值 |
| 18 | 恐怖 | 恐惧、惊吓与不安的情绪累积值 |
| 19 | 抑郁 | 抑郁、绝望与消极的情绪累积值 |
| 20 | 反感 | 对玩家的厌恶、反感与敌意的情绪累积值 |

**实施说明（2026-01-21 更新）**：
- 状态数据获取：`Script/UI/Panel/web_components/status_panel.py` 中的 `_get_pleasure_states()` 和 `_get_other_states()` 方法
- 特殊状态获取：复用 `Script/UI/Panel/character_info_head.py` 中的 `get_character_status_list()` 函数
- 前端渲染：`static/game.js` 中的 `createTargetInfoPanel()` 和 `createStateItem()` 函数
- 样式定义：`static/style.css` 中的 `.state-grid`、`.state-item` 等样式

**状态数据同步修复（2026-01-22 更新）**：
- 发现增量更新机制导致UI组件缺失问题：前端 `renderNewUIContent()` 每次都完全重新渲染，如果只收到增量数据会导致缺失字段的UI组件不被渲染
- 解决方案：在 `in_scene_panel_web.py` 中始终发送完整状态而非增量数据
- 影响：确保快感状态和其他状态在指令结算后能正确同步显示

**指令执行后数据刷新修复（2026-01-21 更新）**：
- **问题根源**：交互指令通过 WebSocket `execute_instruct` 事件执行，但主面板循环仍在 `askfor_all()` 中等待，没有被唤醒来刷新数据
- **解决方案**：
  1. 在 `in_scene_panel_web.py` 中定义刷新信号常量 `WEB_REFRESH_SIGNAL = "__WEB_REFRESH__"`
  2. 在 `_bind_panel_tabs_and_get_ask_list()` 中将刷新信号添加到 `ask_list`，使其成为有效的用户输入选项
  3. 在 `web_server.py` 的 `handle_execute_instruct()` 执行完指令后，设置 `button_click_response = WEB_REFRESH_SIGNAL`
  4. 这会唤醒 `askfor_all()` 并让主循环进入下一次迭代，重新收集并发送包含最新状态数据的完整游戏状态
- **涉及文件**：
  - `Script/UI/Panel/in_scene_panel_web.py`：添加 `WEB_REFRESH_SIGNAL` 常量和 `_handle_refresh_signal()` 方法
  - `Script/Core/web_server.py`：在 `handle_execute_instruct()` 中设置刷新信号

**UI样式更新（2026-01-22 更新）**：
- 增大交互对象信息面板字体大小：从12px调整为14px
- 状态项布局优化：状态名、等级和数值现在在同一行显示（使用 `.state-item-header` 容器）
- 状态条使用 `config_bar` 配置的图片背景（statbar_null.png 作为背景，statbar_true.png 作为填充）

---

## 3. 核心功能模块

### 3.1 模式切换机制
- 在web模式下使用新的web专用主面板代码文件
- 在非web模式（tk模式）下继续使用原有的 `in_scene_panel.py`
- 新的web专用代码文件放置在同一路径下：`Script/UI/Panel/in_scene_panel_web.py`

**实施说明**：
- `in_scene_panel_web.py` 已创建，包含 `InScenePanelWeb` 类
- 模式切换逻辑已在 `Script/UI/Flow/normal_flow.py` 中实现

**渲染机制(2026-01-17更新)**:
- 所有面板统一使用 `index.html` 模板(单页面应用)
- 主面板通过 `new_ui_container` 元素类型渲染新UI
- `InScenePanelWeb` 将游戏状态包装为特殊元素发送到前端
- 前端 `game.js` 根据元素类型自动选择渲染方式

**清屏机制(2026-01-28新增)**:
- `io_web.py` 提供两种清屏函数：
  - `clear_screen()`: 清空当前绘制元素，但保留历史记录（用于循环内更新）
  - `clear_screen_and_history()`: 彻底清空当前绘制元素和历史记录（用于进入主界面）
- `in_scene_panel_web.py` 在 `draw()` 方法开始时调用 `clear_screen_and_history()`
- 作用：确保每次进入主界面时都有一个干净的显示环境，避免显示之前的杂乱信息

### 3.2 流式数据传输
- 首次进入主绘制界面时，加载并确定所有内容
- 后续仅根据后端数据变动，对应更新变动的组件部分
- 未变动的组件保持不变，避免重复渲染
- **示例**：
  - 玩家选择某个交互类型时，仅查询该交互类型影响的数据变动（如角色图像上的部位按钮），其他画面部分不变
  - 结算演出阶段，仅更新底部对话框等涉及的组件，其他组件保持不动

**实施说明**：
- `in_scene_panel_web.py` 中实现了 `_calculate_diff()` 方法用于计算状态差异
- **重要更新（2026-01-22）**：由于前端 `renderNewUIContent()` 采用完全重渲染策略，增量更新会导致UI组件缺失。目前改为始终发送完整状态以确保UI正确显示。增量更新方法保留以备将来前端支持增量合并时启用。
- 前端 `websocket_handler.js` 中已实现增量更新处理（待启用）

### 3.3 场景背景渲染
- 从 `image/场景/` 路径读取场景图片
- 图片匹配规则见 2.2.5 节
- 背景图保持原比例缩放，居中显示

**实施说明**：
- `scene_renderer.py` 中已实现 `SceneRenderer` 类
- 默认回退图片为 `博士办公室.png`

---

## 4. 交互系统设计

### 4.1 指令分类
将原有的统一指令栏拆分为两大类：

#### 4.1.1 面板类指令
- **定义**：点击后将游戏画面从主交互面板切换到特定面板的指令
- **显示位置**：画面最上方的选项卡栏
- **显示形式**：选项卡按钮
- **包含内容**：
  - 系统类功能：移动、存档、读档、系统设置等
  - 查看类功能：查看状态、查看属性、查看关系、收藏列表等
  - 其他需要切换面板的功能
- **自适应规则**：
  - 数量较少时保持固定宽度
  - 数量超过一排时，所有按钮平分一整行宽度

#### 4.1.2 角色交互类指令
- **定义**：对当前交互对象进行各种互动的指令
- **交互流程**：先选择交互类型，然后点击角色（或角色身体部位）进行交互
- **显示位置**：交互类型栏位于画面左侧
- **交互类型示例**：说话、抚摸、亲吻、穿脱等

### 4.2 角色交互流程

#### 4.2.1 基本流程
1. 玩家在交互类型栏选择一个交互大类（如"手"）
2. 选择该大类下的交互小类（如"抚摸"）
3. 角色图像上显示该小类可用的部位按钮（高亮显示）
4. 玩家点击某个部位（如"头部"）
5. 如果该部位在当前小类下只有一个可执行指令，直接执行
6. 如果该部位在当前小类下有多个可选指令，在该部位位置弹出选项菜单
7. 玩家选择具体指令后执行

#### 4.2.2 交互类型按钮行为

**交互大类按钮**：
- 点击大类按钮选择该大类，显示该大类下的小类按钮
- **重复点击**：再次点击已选中的大类按钮，会清空选择（隐藏小类按钮和浮现指令）
- 大类按钮始终显示，不会被隐藏

**交互小类按钮**：
- 选择大类后，显示该大类下的小类按钮列表
- 点击小类按钮选择该小类，显示可用的身体部位和无部位指令
- **重复点击**：再次点击已选中的小类按钮，会清空选择（隐藏部位高亮和浮现指令）
- 小类按钮会根据大类选择动态切换
- **无交互对象时的特殊处理（2026-02-07新增）**：
  - 当玩家没有交互对象（`target_character_id == 0`）时，不显示角色立绘和身体部位按钮
  - 此时**所有指令**（包括有身体部位的指令和无身体部位的指令）统一作为浮现按钮显示
  - 这保证了即使没有交互对象，所有可用指令仍然可以通过浮现按钮访问和执行

#### 4.2.3 选项菜单交互
- 点击某个备选项：执行该指令
- 点击空白位置：收起选项菜单，并清空当前交互大类选择
- 点击其他部位：收起当前菜单，显示其他部位的单一指令或选项菜单

#### 4.2.4 部位显示优化
- **单指令部位**：鼠标悬停时tooltip显示指令名而非部位名
- **多指令部位**：鼠标悬停时tooltip显示部位名
- **无小类选择时**：点击部位显示该部位所有交互类型下的指令

#### 4.2.5 浮现指令列与角色图片重叠处理
- 浮现指令列采用绝对定位，不占用布局空间
- 实时检测浮现指令列与角色显示区是否重叠
- **检测时机**：
  - 渲染浮现按钮后
  - 切换交互大类后
  - 切换交互小类后
- **重叠处理策略**（优先右移，必要时缩小）：
  1. 首先尝试仅右移角色容器避开浮现按钮
  2. 检测右移后是否会与右侧状态栏冲突
  3. 如果不冲突，则仅右移
  4. 如果会冲突，则在右移基础上进行缩小
- 使用 `scale()` 变换确保图片和部位按钮同步缩放，位置保持一致
- 无重叠时角色容器恢复原始大小和位置

#### 4.2.6 空白区域点击
- **空白区域定义**：
  - 主场景背景
  - 角色图像的非按钮区域（立绘本身，但不包括部位按钮）
- **触发效果**：
  - 清空当前交互大类和小类的选择
  - 隐藏浮现指令按钮
  - 恢复角色容器的原始位置和大小
  - **重置身体部位按钮状态**：移除所有高亮和禁用样式，回到初始的全部位可互动状态（既不是 `available` 也不是 `unavailable`）

### 4.3 身体部位点击系统

#### 4.3.1 部位按钮状态管理
- **初始状态**（未选择交互类型）：
  - 全部位可互动，但都没有高亮
  - 没有 `available` 或 `unavailable` 类
- **选择交互小类后**：
  - 该小类可用的部位添加 `available` 类（高亮显示）
  - 该小类不可用的部位添加 `unavailable` 类（禁用状态）
- **清空交互选择后**：
  - 移除所有 `available` 和 `unavailable` 类
  - 回到初始状态（全部位可互动但都没有高亮）

#### 4.3.1.1 臀部子部位高亮映射（2026-02-07新增）
臀部（hip）是一个特殊的可点击部位，它包含多个子部位：
- **子部位列表**：小穴(vagina)、子宫(womb)、后穴(anus)、尿道(urethra)、尾巴(tail)、胯部(crotch)
- **高亮规则**：当选择的交互小类下有任何臀部子部位的指令时，臀部按钮也会高亮显示
- **点击行为**：
  - **已选择小类时**：点击臀部会显示该小类下所有臀部子部位的可用指令列表
  - **未选择小类时**：点击臀部会展开子部位菜单，让用户选择具体子部位
- **实现位置**：
  - 后端：`interaction_handler.py` 的 `_get_available_body_parts_by_minor_type()` 自动添加 `hip` 到可用部位
  - 后端：`web_server.py` 的 `handle_click_body_part()` 处理臀部点击时收集所有子部位指令
  - 前端：`game.js` 的 `updateAvailableBodyParts()` 检测子部位并高亮臀部

#### 4.3.2 部位按钮特性
- **非直接显示**：默认不显示任何UI效果
- **悬停效果**：鼠标移到部位位置时：
  - 鼠标光标变为可点击样式
  - 浮现部位名称的悬浮文本框（如"手部"）
  - 如果该部位在当前小类下只有一个指令，悬浮框显示指令名而非部位名
- **形状**：以部位中心像素位置为圆心的隐形圆形按钮
  - 使用 `aspect-ratio: 1/1` 确保在任何屏幕比例下都是正圆
  - 使用百分比定位确保位置准确

#### 4.3.3 部位位置数据
- 每个角色的立绘图片需要配套一个JSON表格
- JSON内容：每个身体部位的中心位置（像素坐标）
- 部位示例：嘴巴、左手、右手、膝盖、双脚等
- 数据在绘制角色图像时读取并缓存

#### 4.3.4 部位按钮显示时机
- 仅在选择了涉及身体部位的交互类型后才显示
- 根据当前交互类型，仅显示该类型可用的部位按钮
- **示例**：选择"抚摸"类交互后，如果左手和右手都是可用部位，则在左手和右手的中心位置各绘制一个隐形圆形按钮

**实施说明**：
- `web_server.py` 中定义了部位名称的中英文映射（`BODY_PART_NAMES`），并在 `click_body_part` 事件处理中实现中文→英文转换
- `web_server.py` 中使用 `web_interaction_manager` 获取当前小类，根据小类过滤部位指令
- `game.js` 中 `createBodyPartsLayer()` 实现部位按钮渲染，保存tooltip引用用于动态更新
- `game.js` 中 `handleBodyPartClick()` 实现点击检测和指令菜单显示
- `game.js` 中 `handleBodyPartClickResult()` 根据指令数量动态更新tooltip文本
- `game.js` 中 `checkAndAdjustCharacterImage()` 检测浮现指令列与角色图片重叠并自动调整
- 指令菜单（`showInstructMenu()`）在点击的部位右侧显示，超出边界时自动调整位置
- `style.css` 中使用 `aspect-ratio: 1/1` 确保部位按钮始终是正圆形

#### 4.3.5 指令菜单滚动条功能（2026-02-07新增）
- **问题背景**：当某个身体部位的可用指令数量过多时，指令菜单会超出游戏界面底部，导致无法显示全部指令
- **解决方案**：为指令菜单添加滚动条功能
- **实现细节**：
  - **菜单结构**：将指令按钮放入独立的滚动容器（`.instruct-menu-container`）
  - **显示上限**：滚动容器最大高度为400px（约8个指令按钮，每个按钮高度约46px）
  - **滚动条样式**：
    - 宽度：8px
    - 轨道：半透明黑色背景（`rgba(0, 0, 0, 0.3)`）
    - 滑块：金色半透明（`rgba(255, 215, 0, 0.5)`），悬停时变深（`rgba(255, 215, 0, 0.7)`）
  - **自动适应**：当指令数量≤8个时，不显示滚动条；超过8个时自动显示滚动条
  - **高度计算**：菜单定位时根据指令数量动态计算实际高度，避免超出屏幕边界
- **修改文件**：
  - `static/style.css` - 添加 `.instruct-menu-container` 和滚动条样式
  - `static/game.js` - 修改 `showInstructMenu()` 函数，使用滚动容器包裹指令按钮

---

## 5. 角色图像系统

### 5.1 图像图层结构
角色图像由多层图层组成：
1. **底层 - 身体图层**：角色的基础身体立绘
2. **中间层 - 服装图层**：角色当前穿着的服装
3. **上层 - 特效图层**：表情变化、状态特效等

### 5.2 图像显示规则
- **场景无角色时**：不显示角色图像，仅显示背景
- **场景有角色时**：
  - 当前交互对象的全身立绘显示在画面正中央
  - 其他角色以头像形式显示在右上角头像区

### 5.3 图像文件组织
当前立绘位置在 `image/立绘/` 目录，现有图片为tk模式使用的半身图。
需要为每个角色建立单独的文件夹，包含：
- 角色的全身立绘图片
- 角色的半身立绘图片（原有图片重命名后保留）
- 角色的头部图片（用于头像显示）
- 各种差分图层（服装、特效等）
- 身体部位位置的JSON文件

### 5.4 双模式兼容
- **tk模式**：继续读取半身图作为常规立绘使用
- **web模式**：读取全身图作为主立绘使用
- **文件命名规范**：
  - 全身图：`{角色名}_全身.png`
  - 半身图：`{角色名}_半身.png`
  - 头部图：`{角色名}_头部.png`
- **tk模式适配**：需要确保tk模式的图片读取逻辑能够正确识别并读取 `{角色名}_半身.png` 文件

### 5.5 过渡方案
在全身图素材尚未准备完成之前：
- 先使用现有的半身图作为身体底层图片
- 服装层和特效层暂时留空

**实施说明**：
- `character_renderer.py` 中实现了图片查找逻辑，优先全身图、回退到半身图
- `tools/build_character_folders.py` 用于构建文件夹结构
- `tools/rename_and_organize_images.py` 用于重命名现有图片

### 5.6 角色立绘透明区域裁切（2026-02-08新增）

为了优化角色立绘的显示效果，在Web模式下会自动裁切掉图片四周的透明区域，只保留有实际像素内容的部分。

#### 5.6.1 功能说明
- **自动裁切**：加载角色立绘时，自动检测并裁切掉四周的透明像素区域
- **缓存机制**：裁切后的图片存储在内存缓存中，不保存为文件
- **缓存大小**：最多缓存10张图片，采用LRU（最近最少使用）策略
- **部位按钮同步**：身体部位按钮的位置会根据裁切元数据自动调整，确保位置准确

#### 5.6.2 API说明
- **裁切图片API**：`/api/cropped_image/<path:filename>`
- **响应头元数据**：
  - `X-Original-Width`：原始图片宽度
  - `X-Original-Height`：原始图片高度
  - `X-Cropped-Width`：裁切后图片宽度
  - `X-Cropped-Height`：裁切后图片高度
  - `X-Offset-X`：裁切区域相对于原图左上角的X偏移
  - `X-Offset-Y`：裁切区域相对于原图左上角的Y偏移

#### 5.6.3 缓存管理
- **LRU策略**：当缓存已满（10张）且需要新增图片时，自动删除最久未使用的图片
- **访问更新**：每次访问已缓存的图片时，该图片被标记为最近使用
- **存档清理**：保存游戏存档时自动清空图片缓存，避免缓存数据被序列化

#### 5.6.4 实现文件
- **后端图片处理**：`Script/UI/Panel/web_components/image_processor.py`
- **后端API路由**：`Script/Core/web_server.py` 中的 `serve_cropped_image()` 函数
- **存档清理逻辑**：`Script/Core/save_handle.py` 中的 `establish_save_linux()` 函数
- **前端图片加载**：`static/game.js` 中的 `createCharacterDisplay()` 函数
- **前端部位调整**：`static/game.js` 中的 `adjustBodyPartsLayerForCrop()` 函数

#### 5.6.5 身体部位按钮位置调整算法（2026-02-08更新）
裁切会改变图片的显示区域，身体部位按钮需要相应调整以保持正确对齐。

**设计思路**：
- body-parts-layer 的尺寸使用像素值，精确匹配图片的实际渲染尺寸
- 直接更新每个按钮的位置和大小（百分比相对于 layer）
- 按钮位置从"相对于原图的百分比"转换为"相对于裁切后图片的百分比"
- 支持数据坐标系与实际图片坐标系不一致的情况
- 窗口大小变化时自动重新调整

**CSS 要求**：
- `.character-container` 使用 `display: inline-flex; flex-direction: column`，紧密包裹图片同时保持居中
- `.character-image` 使用 `display: block`
- `.body-parts-layer` 使用 `position: absolute`，尺寸由 JS 动态设置为像素值

**数据存储**：
创建按钮时，将以下原图信息保存到按钮的 data 属性中：
- `data-orig-x`：原图中的X坐标（像素）
- `data-orig-y`：原图中的Y坐标（像素）
- `data-orig-size-percent`：原图中的按钮大小（百分比）

创建 body-parts-layer 时，保存数据尺寸到 layer 的 data 属性：
- `data-data-image-width`：数据中定义的图片宽度
- `data-data-image-height`：数据中定义的图片高度

**转换公式**：

1. **Layer 尺寸与位置设置**：
   - 获取图片实际渲染尺寸：`img.offsetWidth` 和 `img.offsetHeight`
   - 获取图片相对于容器的偏移量：`imgRect.left - containerRect.left` 和 `imgRect.top - containerRect.top`
   - 设置 layer 尺寸为像素值（精确匹配图片尺寸）
   - 设置 layer 位置为像素值（精确对应图片在容器内的位置）
   - 这确保无论图片如何在容器内布局（居中等），layer 都能精确覆盖

2. **坐标系缩放**（处理数据尺寸与实际原图尺寸不一致）：
   - 缩放比例X = `originalWidth / dataImageWidth`
   - 缩放比例Y = `originalHeight / dataImageHeight`
   - 实际X = `数据X * 缩放比例X`
   - 实际Y = `数据Y * 缩放比例Y`

3. **位置转换**（从实际原图坐标转换为裁切后图片坐标）：
   - 新X位置 = `((实际X - offsetX) / croppedWidth) * 100%`
   - 新Y位置 = `((实际Y - offsetY) / croppedHeight) * 100%`

4. **大小转换**：
   - 新大小 = `原大小百分比 * (dataImageWidth / croppedWidth)`
   - 这确保按钮相对于裁切后图片的视觉大小正确

**调用时机**：
- 图片首次加载完成后（使用 `requestAnimationFrame` 确保渲染尺寸已确定）
- 窗口大小变化时（通过 resize 事件触发重新调整）

**实现函数**：
- `createBodyPartsLayer()` - 创建按钮时保存原图坐标数据和数据尺寸
- `adjustBodyPartsLayerForCrop()` - 设置 layer 像素尺寸，进行坐标系转换，遍历按钮并更新位置和大小
- `updateCharacterImageHeightOnResize()` - 窗口大小变化时重新应用图片高度和身体部位调整

#### 5.6.6 依赖要求
- 需要安装 `Pillow` 库（PIL）用于图片处理
- 如果 Pillow 未安装，自动回退到原始图片（不裁切）

#### 5.6.7 前端图片缓存（2026-02-08新增）

**问题背景**：
由于前端 `renderNewUIContent()` 采用完全重渲染策略，每次状态更新都会重新创建角色立绘显示区，导致频繁的图片请求。即使后端有 LRU 缓存，前端的重复 fetch 请求仍会产生网络开销和日志刷屏。

**解决方案**：
在前端实现 `croppedImageCache` Map 对象，缓存已加载的裁切图片 blob URL 和元数据。

**缓存机制**：
- 以裁切图片 API URL 为键
- 值包含 `blobUrl`（blob URL）和 `metadata`（裁切元数据）
- 相同 URL 的请求直接使用缓存，不发起 fetch

**缓存清理**：
- 切换交互对象时调用 `clearCroppedImageCache()` 清理缓存
- 清理时释放所有 blob URL（`URL.revokeObjectURL`）避免内存泄漏

**实现函数**：
- `croppedImageCache` - 全局 Map 对象存储缓存数据
- `clearCroppedImageCache()` - 清理缓存并释放 blob URL

---

## 6. 演出与结算系统

### 6.1 结算阶段概述
执行角色交互类指令后，游戏时间会推进一段时间，在此期间：
- 结算所有角色（包括场景内和场景外）的行动
- 三种交互方式（选项卡、交互类型栏、部位按钮）均隐藏为不可用
- 结算完成后，交互重新可用

### 6.2 结算显示规则

#### 6.2.1 玩家与交互对象
- **对话显示**：完整对话框形式，显示在画面最下方
- **对话框样式**：
  - 半透明文本框背景
  - 左侧显示角色名字（如果有交互对象，格式为 `角色名 → 交互对象名`）
  - 内部显示当前台词描述
- **文本推进**：
  - 左键点击画面任意位置：推进一次文本
  - 按住右键或Ctrl键：快速跳过该角色的文本
- **数值变化浮动文本**：
  - 对话完毕后显示该角色的数值变化
  - 每个数值使用独特颜色（与settle_behavior.py中的富文本颜色一致）：
    - 体力：`#e15a5a`（红色）
    - 气力：`#70C070`（绿色）
    - 好感：`#ffb6c1`（浅粉红）
    - 信赖：`#96bbab`（夏日绿）
    - 射精欲：`#fffacd`（柠檬色）
    - 理智：`#7070C0`（紫蓝色）
    - 经验：`#00ff7f`（春绿色）
    - 快感状态：`#f77fbe`（波斯粉）
    - 负面状态：`#6a5acd`（岩蓝灰）
  - **交互对象的数值变化位置**（2026-02-07更新）：
    - 体力/气力/好感/信赖/催眠度变化：显示在数值后面，格式如 `100/200 +20`
    - 使用 `position-end-inline` 类，作为内联元素显示
    - 不再下移一行或使用特殊绝对定位
    - 状态栏数值变化：在对应状态项右侧显示（位置不变）
    - 经验值/其他变化：在面板底部统一显示
  - 显示效果：无框文本跳出，2秒后0.5秒渐变消失
  - 多个变化同时显示，各自在对应位置

#### 6.2.2 场景内其他角色
- **对话显示**：小型对话框形式，显示在该角色头像下方
- **对话内容**：仅显示行为台词描述的前N个字符，后接省略号
- **数值变化**：不显示
- **无结算时**：如果该时间段内未结算该角色，则不显示任何内容

### 6.3 结算后的头像交互
结算完成、交互恢复可用后：
- 对于有对话框显示的非交互角色，点击其头像：
  1. 将该角色设为当前交互对象
  2. 在底部完整对话框中重新按行显示该角色的完整行为台词描述
  3. 显示完毕后，按相同逻辑显示该角色的状态数值变化

**实施说明（2026年1月19日更新）**：
- 前端 `interaction_manager.js` 中实现了结算阶段的UI状态管理
- 前端 `ui_components.js` 中 `DialogBox` 类实现了对话框交互
- **对话框实现详情**：
  - 后端：`Script/UI/Panel/web_components/dialog_box.py` 提供全局对话框管理函数
    - `add_dialog_text()` - 添加对话到队列（支持分页和小对话框）
    - `advance_dialog()` - 推进对话
    - `get_dialog_state()` - 获取对话框状态（包含小对话框列表）
    - `_trigger_state_update()` - 触发状态推送到前端
    - `_split_text_to_pages()` - 将文本按行数分页（每页最多4行）
    - `clear_minor_dialogs()` - 清空小对话框
  - 前端：`static/game.js` 中 `createDialogBox()` 和 `updateDialogBox()` 实现渲染
  - 样式：`static/style.css` 中 `.new-ui-dialog-box` 系列样式
  - talk.py的 `handle_talk_draw()` 在Web模式下自动将台词发送到对话框
  - 支持点击推进、空格/回车推进、右键/Ctrl快速跳过
- **文本分页规则（2026年1月19日更新）**：
  - 每页最多显示4行文本（按显式换行符 `\n` 计算）
  - 不强制按字符数截断词语，由前端CSS的`word-wrap`处理自动换行
  - 超过4行的文本自动分页，后续页面需点击推进显示
  - 分页时右下角显示"(还有更多...)"提示
  - 长行按50字符/行估算显示行数，用于分页计算
- **主/小对话框区分（2026年1月19日更新）**：
  - 主对话框：显示玩家(0)和当前交互对象的台词
  - 小对话框：显示场景内其他角色的台词（在头像下方悬浮）
  - 小对话框样式：漫画风格向下悬浮，带三角形指示器
  - 小对话框字体大小与角色姓名一致（0.7em）
  - 小对话框尺寸：宽度80-110px，高度2.8-4.5em，支持2-3行文本自动换行
- **角色姓名显示修复（2026年1月19日新增）**：
  - 头像区角色姓名支持完整显示（允许自动换行）
  - `.avatar-name` 样式修改为 `white-space: normal` 允许换行
  - 添加 `word-wrap: break-word; word-break: break-all` 支持长名字断行
- **交互对象名称显示（2026年1月19日新增）**：
  - 在主对话框中，如果角色有交互对象，说话者名称格式为 `{角色名} → {交互对象名}`
  - 在 `add_dialog_text()` 中通过 `target_character_id` 参数实现
  - 在 `talk.py` 的 `handle_talk_draw()` 中自动传递交互对象ID
  - 宽度限制避免相邻对话框水平重叠（基于头像间距56px计算）
  - 鼠标悬停显示完整文本（title属性工具提示）
  - 防截断处理：顶部信息区和头像面板设置 `overflow: visible`
  - 重叠优先级：右侧角色对话框在上层（通过递增z-index实现）
  - 防闪烁：移除头像hover时的transform缩放，仅保留背景色过渡
- **切换交互对象联动（2026年1月19日新增）**：
  - 点击角色头像触发 `switch_target` WebSocket事件
  - 后端更新 `target_character_id` 并设置 `web_need_full_refresh` 标志
  - 下一次状态更新时发送完整状态（跳过增量计算）
  - 主界面立绘、身体部位、右上角头像列表自动同步更新
- **WebSocket事件**：
  - `dialog_state_update` - 对话框状态更新（由talk.py触发）
  - `advance_dialog` - 请求推进对话（前端发送）
  - `dialog_advanced` - 对话推进结果（后端响应）
  - `skip_all_dialogs` - 跳过所有对话（前端发送）
  - `dialogs_skipped` - 对话跳过结果（后端响应）

---

## 7. 指令分类系统

### 7.1 分类定义（更新于 2026年1月17日）
需要在指令定义文件 `Script/System/Instruct_System/handle_instruct.py` 中，为每个指令补充交互类型相关信息。

#### 7.1.1 指令大类（三类分类系统）
每个指令需要定义属于以下三种大类之一：

| 分类 | 英文标识 | 触发方式 | 说明 |
|------|---------|---------|------|
| 系统面板类 | `SYSTEM_PANEL` | 点击选项卡按钮 | 函数内容为 `cache.now_panel_id = xxx` 的指令 |
| 角色交互类 | `CHARACTER` | 选择交互类型 → 点击身体部位 | 普通的角色交互指令，直接执行并结算 |
| 角色交互面板类 | `CHARACTER_PANEL` | 选择交互类型 → 点击身体部位 | 函数内容带有 `now_panel.draw()` 的指令，触发后打开临时面板 |

**系统面板类指令执行流程**：
1. 玩家点击选项卡栏的按钮
2. 执行指令，切换到对应面板
3. 在新面板中进行操作

**角色交互面板类指令执行流程**：
1. 玩家选择交互类型
2. 点击角色身体部位
3. 创建临时选项卡面板并自动切换
4. 在临时面板中进行选择
5. 选择完成后进行结算
6. 自动退出临时面板，返回主场景

#### 7.1.2 角色交互子类型（更新于 2026年1月17日）
对于角色交互类和角色交互面板类指令，需要定义交互子类型：

| 子类型 | 英文标识 | 说明 |
|-------|---------|------|
| 说话 | `TALK` | 聊天、交谈、询问等语言交流 |
| 接触 | `TOUCH` | **合并原抚摸和性触摸**，包括摸头、牵手、拍肩、性触摸等所有身体接触 |
| 口部 | `ORAL` | **合并原亲吻和口交**，包括亲吻、舔舐、口交等口部相关交互 |
| 穿脱 | `DRESS` | 穿脱衣物、整理服装等 |
| 侍奉 | `SERVICE` | 被动接受对方的服侍（**排在插入类之前**） |
| 插入 | `INSERT` | 性交相关指令 |
| 道具 | `ITEM` | **从特殊类拆分**，使用道具进行交互 |
| 药物 | `DRUG` | **从特殊类拆分**，使用药物进行交互 |
| 其他 | `OTHER` | 不属于上述类别的交互 |

**显示顺序**：说话 → 接触 → 口部 → 穿脱 → 侍奉 → 插入 → 道具 → 药物 → 其他

#### 7.1.3 身体部位关联
对于涉及身体部位的指令，需要定义关联的部位列表。
部位定义基于 `data/csv/BodyPart.csv` 和 COCO-WholeBody 17个关键点。

### 7.2 实施完成 ✅（更新于 2026年1月17日）

#### 7.2.1 新增枚举和数据结构
已在 `Script/System/Instruct_System/` 目录下定义：

**instruct_category.py - 指令大类**：
```python
class InstructCategory:
    """指令大类（三类分类）"""
    SYSTEM_PANEL = 0    # 系统面板类：函数为cache.now_panel_id = xxx
    CHARACTER = 1       # 角色交互类：普通交互，直接执行
    CHARACTER_PANEL = 2 # 角色交互面板类：函数带now_panel.draw()
```

**interaction_types.py - 交互类型（新系统，2026-01-22更新）**：
```python
class InteractionMajorType:
    """交互大类型（按使用器官/工具分类）- 所有值均为字符串标识符"""
    MOUTH = "mouth"    # 嘴类：对话、亲吻、舔吸
    HAND = "hand"      # 手类：抚摸、拍打、穿脱、日常、娱乐、工作
    SEX = "sex"        # 性爱类：开始与结束、基础（2026-01-22新增）
    PENIS = "penis"    # 阴茎类：摩擦、插入
    TOOL = "tool"      # 道具类：药物、道具
    ARTS = "arts"      # 技艺类：信息素、透视、催眠、时停
    OTHER = "other"    # 其他

class InteractionMinorType:
    """交互小类型（每个大类下的子分类）- 所有值均为字符串标识符"""
    # 嘴类（MOUTH='mouth'）
    MOUTH_TALK = "mouth_talk"     # 对话
    MOUTH_KISS = "mouth_kiss"     # 亲吻
    MOUTH_LICK = "mouth_lick"     # 舔吸
    # 手类（HAND='hand'）
    HAND_TOUCH = "hand_touch"     # 抚摸
    HAND_SLAP = "hand_slap"       # 拍打
    HAND_DRESS = "hand_dress"     # 穿脱
    HAND_DAILY = "hand_daily"     # 日常
    HAND_PLAY = "hand_play"       # 娱乐
    HAND_WORK = "hand_work"       # 工作
    # 性爱类（SEX='sex'）（2026-01-22新增）
    SEX_START_END = "sex_start_end"  # 开始与结束（邀请H、结束H等）
    SEX_BASE = "sex_base"            # 基础（H中的基础操作）
    # 阴茎类（PENIS='penis'）
    PENIS_RUB = "penis_rub"       # 摩擦
    PENIS_INSERT = "penis_insert" # 插入
    # 道具类（TOOL='tool'）
    TOOL_DRUG = "tool_drug"       # 药物
    TOOL_ITEM = "tool_item"       # 道具
    # 技艺类（ARTS='arts'）
    ARTS_HORMONE = "arts_hormone"     # 信息素
    ARTS_XRAY = "arts_xray"           # 透视
    ARTS_HYPNOSIS = "arts_hypnosis"   # 催眠
    ARTS_TIME_STOP = "arts_time_stop" # 时停
    # 其他类（OTHER='other'）
    OTHER_MISC = "other_misc"     # 杂项
```

**instruct_category.py - 身体部位**：
```python
class BodyPart:
    """身体部位常量（基于BodyPart.csv和COCO-WholeBody）"""
    HAIR = "hair"          # 头发 (csv id:0)
    FACE = "face"          # 脸部 (csv id:1)
    MOUTH = "mouth"        # 口腔 (csv id:2)
    CHEST = "chest"        # 胸部 (csv id:3)
    ARMPIT = "armpit"      # 腋部 (csv id:4)
    HAND = "hand"          # 手部 (csv id:5) - 合并左右手
    VAGINA = "vagina"      # 小穴 (csv id:6) - 臀部子部位
    WOMB = "womb"          # 子宫 (csv id:7) - 臀部子部位
    ANUS = "anus"          # 后穴 (csv id:8) - 臀部子部位
    URETHRA = "urethra"    # 尿道 (csv id:9) - 臀部子部位
    LEG = "leg"            # 腿部 (csv id:10) - 合并左右腿
    FOOT = "foot"          # 脚部 (csv id:11) - 合并左右脚
    TAIL = "tail"          # 尾巴 (csv id:12) - 臀部子部位
    HORN = "horn"          # 兽角 (csv id:13)
    BEAST_EARS = "beast_ears"  # 兽耳 (csv id:14)
    STOMACH = "stomach"    # 胃部 (csv id:15) - 内部
    CROTCH = "crotch"      # 胯部 (csv id:16)
    BELLY = "belly"        # 腹部 (csv id:17)
    BACK = "back"          # 背部 (csv id:18)
    HEAD = "head"          # 头部（虚拟）
    HIP = "hip"            # 臀部（复合，点击展开5个子部位）
```

#### 7.2.2 COCO-WholeBody 17点到部位的映射
```python
# COCO关键点索引: 0-鼻子, 1-左眼, 2-右眼, 3-左耳, 4-右耳, 5-左肩, 6-右肩,
#                7-左肘, 8-右肘, 9-左手腕, 10-右手腕, 11-左胯, 12-右胯,
#                13-左膝, 14-右膝, 15-左脚踝, 16-右脚踝

# 映射规则：
# - 左右对称的部位合并为同一个（如左手9+右手10 → 手部）
# - 头部位于鼻子(0)正上方
# - 胸部位于双肩(5,6)正中间
# - 兽角位于双耳(3,4)正上方
# - 臀部位于双胯(11,12)正中间，点击时展开5个子部位
```

#### 7.2.3 臀部子部位展开机制
点击臀部时展开以下5个子部位：
1. 小穴 (VAGINA)
2. 子宫 (WOMB)
3. 后穴 (ANUS)
4. 尿道 (URETHRA)
5. 尾巴 (TAIL)

#### 7.2.4 扩展后的 add_instruct 函数

```python
def add_instruct(
    instruct_id: int,
    instruct_type: int,
    name: str,
    premise_set: Set,
    behavior_id: str = "share_blankly",
    sub_type: int = 0,
    # ========== Web模式分类参数 ==========
    category: Optional[int] = None,      # 默认自动推断
    panel_id: Optional[int] = None,      # 系统面板类的面板ID
    interaction_type: Optional[int] = None,  # 交互子类型
    body_parts: Optional[List[str]] = None,  # 关联身体部位
    # 注：single_part 已移除，改用 InstructMeta.is_single_part 属性（通过 body_parts 长度自动判断）
    # =====================================
):
```

#### 7.2.5 自动推断逻辑（通过分析函数源代码）
1. 检查函数源代码是否包含 `cache.now_panel_id` 且不包含 `now_panel.draw()` → `SYSTEM_PANEL`
2. 检查函数源代码是否包含 `now_panel.draw()` → `CHARACTER_PANEL`
3. 若 `instruct_type == SYSTEM` → `SYSTEM_PANEL`
4. 若 `instruct_type in (OBSCENITY, SEX)` → `CHARACTER`
5. 其他 → `CHARACTER`

#### 7.2.6 查询辅助函数
已在 `Script/System/Instruct_System/instruct_meta.py` 中实现：
- `get_system_panel_instructs()` - 获取所有系统面板类指令
- `get_character_instructs()` - 获取所有角色交互类指令
- `get_character_panel_instructs()` - 获取所有角色交互面板类指令
- `get_all_character_interaction_instructs()` - 获取所有角色交互相关指令
- `get_instructs_by_interaction_type(type)` - 按交互子类型获取指令
- `get_instructs_by_body_part(part)` - 按部位获取相关指令
- `get_instructs_by_type_and_part(type, part)` - 按类型和部位获取指令
- `get_available_interaction_types()` - 获取可用交互类型（按预定义顺序）
- `get_instruct_meta(instruct_id)` - 获取单个指令元数据

---

## 8. 素材处理流程

### 8.1 角色文件夹构建流程

#### 8.1.1 第一步：创建角色文件夹
- 遍历 `image/立绘/干员` 根路径下的所有png文件
- 为每个png文件在 `image/立绘/干员/差分` 目录下建立同名文件夹
- 将png文件移动到对应文件夹中

#### 8.1.2 第二步：获取全身图并重命名半身图
- 遍历 `image/立绘/干员/差分` 中的所有文件夹
- 在每个文件夹中找到文件名不含下划线的png文件（即原始半身图）
- 将原半身图重命名为 `{角色名}_半身.png`
- 使用 `tools/download_prts_character_image.py` 脚本下载该角色的全身图
- 将下载的全身图命名为 `{角色名}_全身.png` 并移动到角色文件夹

#### 8.1.3 第三步：生成部位位置JSON
- 创建单独的脚本，处理每个角色的全身图
- 分析图像，提取所有身体部位的像素位置
- 将分析结果存储为JSON文件，放入每个角色的文件夹中
- **特殊要求**：由于角色图像均为日本动漫风格，需要查找该特定领域的更优识别方案以提升准确率

**实施说明**：
- 当前 `generate_body_parts_json.py` 使用基于图像比例的简化估计方法
- 后续可考虑使用MMPose等深度学习模型提升准确度

### 8.2 tk模式兼容性处理
- 重命名后的半身图文件名格式为 `{角色名}_半身.png`
- 需要同步修改tk模式下的图片读取逻辑，使其能够正确识别新的文件名格式
- 确保tk模式在新的文件结构下能够正常读取半身图作为常规立绘使用

### 8.3 最终文件结构
```
image/立绘/干员/差分/{角色名}/
├── {角色名}_全身.png      # 全身立绘（web模式使用）
├── {角色名}_半身.png      # 半身图（tk模式使用，原有图片重命名）
├── {角色名}_头部.png      # 头部图（头像显示使用）
├── body_parts.json        # 身体部位位置数据
└── ...                    # 其他差分图层（待扩展）
```

---

## 9. 文件结构规划

### 9.1 新建代码文件
```
Script/UI/Panel/
├── in_scene_panel.py           # 原有tk模式主面板（保留不变）
├── in_scene_panel_web.py       # 新建：web模式主面板 ✅
└── web_components/             # 新建：web专用组件目录 ✅
    ├── __init__.py             # ✅
    ├── scene_renderer.py       # 场景背景渲染组件 ✅
    ├── character_renderer.py   # 角色图像渲染组件 ✅
    ├── interaction_handler.py  # 交互处理组件 ✅
    ├── dialog_box.py           # 对话框组件 ✅
    ├── status_panel.py         # 状态面板组件 ✅
    ├── tab_menu.py             # 选项卡菜单组件 ✅
    └── body_part_button.py     # 身体部位按钮组件 ✅

Script/Core/constant/
├── __init__.py                 # 修改：添加Web分类数据字典 ✅
└── instruct_category.py        # 新建：指令分类枚举定义 ✅

Script/Design/
├── handle_instruct.py          # 修改：扩展add_instruct参数 ✅
└── instruct_meta.py            # 新建：指令元数据管理 ✅

Script/Config/
└── instruct_web_config.py      # 新建：指令Web分类配置 ✅
```

### 9.2 新建前端文件
```
templates/
├── index.html                  # 原有（可能需要改造）
└── game_main.html              # 新建：主游戏页面 ✅

static/
├── css/
│   └── game_main.css           # 游戏主界面样式 ✅
├── js/
│   ├── game_renderer.js        # 画面渲染器 ✅
│   ├── interaction_manager.js  # 交互管理器 ✅
│   ├── websocket_handler.js    # WebSocket处理 ✅
│   └── ui_components.js        # UI组件库 ✅
└── assets/
    └── ui/                     # UI素材目录 ✅
```

### 9.3 新建工具脚本
```
tools/
├── download_prts_character_image.py  # 已有：下载角色图片
├── build_character_folders.py        # 新建：构建角色文件夹结构 ✅
├── rename_and_organize_images.py     # 新建：重命名和整理图片 ✅
└── generate_body_parts_json.py       # 新建：生成部位位置JSON ✅
```

### 9.4 素材目录结构
```
image/
├── 场景/                       # 场景背景图
│   ├── 博士办公室.png          # 默认背景
│   ├── 卧室.png
│   ├── 走廊.png
│   └── ...
└── 立绘/
    └── 干员/
        └── 差分/
            ├── {角色A}/
            │   ├── {角色A}_全身.png
            │   ├── {角色A}_半身.png
            │   ├── {角色A}_头部.png
            │   └── body_parts.json
            ├── {角色B}/
            │   └── ...
            └── ...
```

### 9.5 需要修改的现有文件
- `Script/System/Instruct_System/handle_instruct.py`：增加指令分类和交互类型信息
- `Script/Core/web_server.py`：添加新的WebSocket事件处理和 `push_game_state()` 函数
- `Script/UI/Panel/in_scene_panel.py`：添加模式切换逻辑
- tk模式的立绘读取相关代码：适配新的半身图文件名格式 `{角色名}_半身.png`

---

## 附录：术语说明

| 术语 | 说明 |
|------|------|
| tk模式 | 基于Tkinter的原有文本界面模式 |
| web模式 | 基于网页的新图形界面模式 |
| 交互类型 | 对角色进行互动的类别（说话、抚摸、亲吻等） |
| 部位按钮 | 角色立绘上的隐形可点击区域 |
| 面板类指令 | 点击后切换显示面板的指令 |
| 角色交互类指令 | 对角色进行互动的指令 |
| 结算阶段 | 执行指令后的时间推进和行动结算过程 |
| 流式传输 | 仅传输变动数据以提升性能的方式 |
| 快感状态 | 与角色快感相关的状态数值 |
| 全身图 | 从头到脚的完整角色立绘（web模式使用） |
| 半身图 | 上半身角色立绘（tk模式使用） |
| 头部图 | 角色头部图片（用于头像区显示） |
| 特殊状态标记 | 用`<>`符号包裹的各种状态标识 |

---

## 附录B：实施记录

### 2026-01-13 更新
- 完成阶段一基础架构搭建
- 所有后端组件文件已创建并填充基础实现
- 所有前端文件已创建并填充完整实现
- 工具脚本已创建
- 文档移动到 `design_docs/` 目录

### 阶段二完成记录（指令分类系统）
- 创建了 `Script/System/Instruct_System/instruct_category.py`
- 创建了 `Script/System/Instruct_System/instruct_meta.py`
- 创建了 `Script/Config/instruct_web_config.py`
- 扩展了 `handle_instruct.py` 的 `add_instruct()` 函数

### 阶段五API集成记录
- 更新 `web_server.py` 中的所有WebSocket事件处理器
- 添加了以下新事件：
  - `get_interaction_types` - 获取可用交互类型列表
  - `get_panel_instructs` - 获取面板类指令列表

### 阶段六结算系统记录
- 创建了 `Script/UI/Panel/web_components/settlement_manager.py`
- 定义了 `SettlementPhase` 枚举和 `SettlementManager` 类
- 添加了以下WebSocket事件：
  - `advance_dialog` - 推进对话显示
  - `get_settlement_state` - 获取当前结算状态
  - `get_character_dialog` - 获取指定角色的完整对话
- 在 `web_server.py` 中添加了 `get_settlement_manager()` 单例函数

