# erArk Web绘制模式UI重构说明文档

## 目录
1. [项目概述](#1-项目概述)
2. [画面布局设计](#2-画面布局设计)
3. [核心功能模块](#3-核心功能模块)
4. [交互系统设计](#4-交互系统设计)
5. [角色图像系统](#5-角色图像系统)
6. [演出与结算系统](#6-演出与结算系统)
7. [指令分类系统](#7-指令分类系统)
8. [素材处理流程](#8-素材处理流程)
9. [地图渲染系统](#9-地图渲染系统)
10. [文件结构规划](#10-文件结构规划)

**最后更新**: 2026年2月12日

**重要架构说明**:
- 采用单页面应用架构：所有面板统一使用 `index.html`
- 主面板新UI通过 `new_ui_container` 元素类型在同一页面内渲染
- 详细实现流程见《Web绘制模式UI重构实现流程.md》

---

## 1. 项目概述

### 1.1 重构目标
将当前erArk游戏的web绘制模式从类似tk模式的文本式UI，重构为一个现代化、图形化、交互友好的游戏界面。

### 1.2 设计原则
- **横屏显示**：默认分辨率1920×1080（1080P）
- **主要目标设备**：台式电脑
- **流式数据传输**：仅更新变动的组件，保持流畅性
- **图形化交互**：以角色图像为核心的交互方式

### 1.3 核心变更概览

| 项目 | 原方案 (tk模式) | 新方案 (web模式) |
|------|----------------|-----------------|
| 显示方式 | 文本列表式 | 图形化界面 |
| 交互方式 | 点击指令列表 | 选择交互类型+点击角色/部位 |
| 角色显示 | 半身图列表 | 全屏背景+中央全身立绘 |
| 指令分类 | 统一指令栏 | 两类指令分区显示（面板类+角色交互类） |
| 数值反馈 | 文本输出 | 动画化数值变动 |

### 1.4 相关现有文件
- 主面板：`Script/UI/Panel/in_scene_panel.py`
- Web服务器：`Script/Core/web_server.py`
- Web流程处理：`Script/Core/flow_handle_web.py`
- Web IO：`Script/Core/io_web.py`
- 模板文件：`templates/index.html`
- 指令定义：`Script/System/Instruct_System/handle_instruct.py`
- 角色信息：`Script/UI/Panel/character_info_head.py`
- 角色状态：`Script/UI/Panel/see_character_info_panel.py`
- 角色服装：`Script/UI/Panel/cloth_panel.py`
- 角色身体：`Script/UI/Panel/dirty_panel.py`
- 群交面板：`Script/System/Sex_System/group_sex_panel.py`
- 隐奸面板：`Script/System/Sex_System/hidden_sex_panel.py`

### 1.5 交互对象系统

玩家的交互对象由 `Character` 类的 `target_character_id` 属性定义。

#### 1.5.1 交互对象判断逻辑
- **有交互对象**：当 `target_character_id > 0` 时
- **无交互对象**：当 `target_character_id == 0`（等于玩家自己的cid）时
- **无效值**：当 `target_character_id < 0` 时

#### 1.5.2 交互对象相关的UI元素
| 区域 | 显示内容 | 无交互对象时 |
|------|---------|-------------|
| 正中间角色立绘区 | 交互对象的全身立绘 + 身体部位按钮 | 不显示 |
| 最右边交互对象信息区 | 交互对象的核心状态信息 | 不显示 |
| 上方中间附加信息区 | 交互对象的服装/身体/群交/隐奸信息 | 不显示 |
| 上方右边头像区 | 场景内除玩家和交互对象外的角色 | 显示场景内除玩家外的所有角色 |

#### 1.5.3 切换交互对象
- **操作方式**：点击头像区的角色头像
- **刷新流程**：前端发送 `switch_target` 事件 → 后端更新 `target_character_id` → 设置刷新信号 → 主循环刷新并推送新状态

---

## 2. 画面布局设计

### 2.1 整体布局（1920×1080）

```
┌─────────────────────────────────────────────────────────────────────────┐
│ [场景信息栏]                                                             │
│  当前位置:罗德岛·办公楼·博士办公室     时间:2099年 春 1日 6点0分 周一       │
├─────────────────────────────────────────────────────────────────────────┤
│ [面板选项卡栏]                                                           │
│  移动 | 存档 | 读档 | 设置 | 状态 | 属性 | 关系 | 收藏 | ...                 │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌──────────────────────┐ ┌──────────────────────────┐ ┌──────────────┐ │
│ │                      │ │ [服装栏][身体栏][群交][隐奸]│ │  [头像区]    │ │
│ │   [玩家信息区]        │ │ 交互对象的服装/身体/      │ │   ○○○    │ │
│ │                      │ │ 群交/隐奸信息             │ │    ○○ ▷   │ │
│ └──────────────────────┘ └──────────────────────────┘ └──────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                          [背景图层]                                      │
│                                                       ┌──────────────┐  │
│    ┌──────────┐                                       │[交互对象信息]│  │
│    │          │         ┌─────────────────┐           │              │  │
│    │ [交互    │         │                 │           │ 名字 好感 信赖│  │
│    │  类型栏] │         │   [角色立绘]     │           │ [体力槽][气力]│  │
│    │          │         │    (中央)       │           │ <特殊状态... > │  │
│    │ ○说话    │         │                 │           │ ─快感状态─   │  │
│    │ ○抚摸    │         │  (可点击部位    │           │ ○○○○       │  │
│    │ ○亲吻    │         │   隐形按钮)     │           │ ○○○○       │  │
│    │ ○穿脱    │         │                 │           │ ─其他状态─   │  │
│    │ ...       │         └─────────────────┘           │ ○○○○       │  │
│    └──────────┘                                       │ ○○○○       │  │
│                                                       └──────────────┘  │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │                        [对话框区域]                                  │ │
│ │  [角色名]  这是当前的一句台词描述文本，点击任意位置继续...               │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 各区域说明

#### 2.2.0 场景信息栏（最顶部）
- **位置**：画面最上方，横向占满整个屏幕宽度
- **内容**：左侧显示当前场景名，中间显示游戏时间
- **样式**：单行高度，深色背景，场景名固定左侧，时间居中
- **数据来源**：场景名使用 `attr_text.get_scene_path_text()` + 门锁状态；游戏时间使用 `game_time` 模块信息

#### 2.2.1 面板选项卡栏（顶部）
- **位置**：场景信息栏下方，横向占满整个屏幕宽度
- **内容**：主面板选项卡 + 所有满足条件的系统面板类指令选项卡
- **样式**：网页选项卡样式（底部边框高亮表示激活状态）
- **选项卡组成**：
  1. **主面板选项卡**：始终存在，默认激活，id 为 `__main_panel__`
  2. **系统面板类选项卡**：动态获取所有满足前提条件的系统面板类指令
- **自适应规则**：选项卡数量较少时保持固定宽度；数量超过一排时自动换行显示

#### 2.2.2 玩家信息区（左上）
- **位置**：选项卡栏下方左侧
- **内容**：玩家角色的信息
- **排版规则**：
  - **第一行**：名字按钮（可点击执行"与自己交互"指令）+ 昵称
  - **第二行**：体力槽 + 气力槽 + 理智槽 + 精液槽
  - **第三行**：特殊状态标记
- **状态槽显示**：使用 `/image/状态条/` 目录下的图片资源绘制
- **快速使用药剂功能**：理智槽和精液槽标签后有加号按钮，可快速使用对应药剂
- **数值变化浮动文本**：显示体力、气力、理智、精液、经验的变化，浮动文本15秒后自动淡出

#### 2.2.3 交互对象附加信息区（中上）
- **位置**：选项卡栏下方中央
- **内容**：当前交互对象的附加信息
  - 服装栏：显示当前穿着的服装信息
  - 身体栏：显示身体各部位污浊状态
  - 群交栏：群交模式下的相关信息
  - 隐奸栏：隐奸模式下的相关信息
- **栏位按钮**：顶部显示栏位名称按钮，点击可展开/收起对应栏位
- **详细污浊按钮**：切换是否显示完整污浊描述
- **全部位显示按钮**：
  - 控制角色立绘上的身体部位按钮是否始终显示（高亮脉冲动画）
  - 开启时，在右侧交互对象信息区底部显示可选部位打印区
  - 可选部位数量与当前交互状态相关：未选择小类时显示所有部位，选择小类后只显示该小类对应的可选部位
- **H模式服装交互**：在H模式下，服装名称显示为可点击按钮，点击可切换穿脱状态
- **悬停延展显示**：默认高度150px无滚动条，鼠标悬停时向下延展显示全部内容
- **无交互对象时不显示**

#### 2.2.4 头像区（右上）
- **位置**：选项卡栏下方右侧
- **内容**：场景内所有角色（除玩家和当前交互对象之外）的头像
- **头像图片**：使用 `{角色名}_头部.png` 作为头像图片
- **布局规则**：单行显示，最多显示5个头像，超过5个时显示翻页按钮
- **交互**：点击头像可切换当前交互对象
- **点击角色时联动显示**：如果该角色有待显示的行为文本和数值变化，点击后会完整显示

#### 2.2.5 主画面区（中央）
- **位置**：画面中央主体区域
- **内容**：
  - **背景图层**：当前场景的地点图像，位于最底层
  - **角色立绘**：当前交互对象的全身立绘，居中显示
- **背景图规则**：优先查找 `image/场景/{地点名}.png`，若不存在则使用默认图片
- **角色立绘高度缩放规则**：
  - 可用高度 > 1024像素时，图片高度固定为1024像素
  - 可用高度 ≤ 1024像素时，图片高度设为可用高度
  - 宽度等比例缩放，图片居中显示
  - 身体部位按钮位置随图片同步缩放
- **与浮现按钮重叠处理**：优先右移角色图片回避，如有冲突则进一步缩小
- **无交互对象时**：角色立绘区不显示，只显示背景图层

#### 2.2.6 交互类型面板（左侧）
- **位置**：主画面区的左侧边缘，垂直居中
- **样式**：采用《明日方舟》风格的悬浮卡片设计
  - **布局**：紧凑型纵向布局（图标在上，文字在下），宽度约120px
  - **大类卡片**：中文名（加粗）与英文名（Tech字体）上下排列，避免重叠
  - **小类卡片**：在大类被选中后，以手风琴方式展开显示在下方，尺寸稍小
  - **浮现指令卡片**：无部位指令（如"自己脱衣"）以卡片形式显示在当前选中的小类卡片下方
- **内容**：角色交互类型选择面板，采用大类/小类两级嵌套结构
- **大类（7个）**：嘴(mouth)、手(hand)、性爱(sex)、阴茎(penis)、道具(tool)、技艺(arts)、其他(other)
- **聚焦模式**：当选择某个交互小类后，会自动隐藏其他未选中的大类，仅显示当前的大类、小类及相关浮现指令，保持界面简洁。点击空白区域可重置恢复。
- **交互动画**：悬停时卡片回正并放大，点击时有高亮反馈（金色/红色主题色）
- **功能**：作为具体的指令分类过滤器，选择小类后会高亮身体部位或显示无部位指令
- **交互流程**：点击大类卡片（展开小类）→ 点击小类卡片（激活分类）→ 点击高亮的身体部位执行指令

#### 2.2.7 交互对象信息区（右侧）
- **位置**：主画面区的右侧边缘
- **内容**：当前交互对象的核心状态信息
- **排版规则**：
  - **第一行**：角色名字 + 好感度 + 信赖度
  - **第二行**：体力槽 + 气力槽
  - **第三行**：特殊状态标记
  - **第四行起**：角色状态槽（快感状态块 + 其他状态块，每行显示4个状态）
  - **可选部位打印区**（全部位显示开启时）：显示当前可选的身体部位，每行2个
- **可选部位打印区说明**：
  - 仅在交互对象附加信息区开启"全部位显示"时显示
  - 未选择交互小类时：显示交互对象身上的所有可交互部位
  - 选择了交互小类后：显示角色立绘中存在的部位与该小类对应部位的交集
  - 部位映射规则：头部子部位（头发/兽角/兽耳）→ 头部，臀部子部位（小穴/尾巴等）→ 臀部
  - 点击部位项可触发部位点击事件
  - 切换交互类型时自动同步刷新（通过WebSocket事件更新）
- **无交互对象时不显示**

#### 2.2.8 对话框区域（底部）
- **位置**：画面最下方
- **样式**：经典文字冒险游戏/恋爱游戏的对话框风格（半透明背景，左侧角色名字，内部台词）
- **交互**：左键点击推进文本，按住右键或Ctrl键快速跳过

### 2.3 角色信息数据来源

#### 2.3.1 基础信息
- **名字**：角色名称
- **昵称**：仅玩家显示
- **好感度**：仅NPC显示，包含数值和等级
- **信赖度**：仅NPC显示，包含数值和等级

#### 2.3.2 数值槽
| 槽类型 | 显示对象 | 说明 |
|-------|---------|------|
| 体力槽 | 全部角色 | 最低为1时会疲劳到无法行动 |
| 气力槽 | 全部角色 | 最低为0时使体力消耗增加 |
| 理智槽 | 仅玩家 | 使用源石技艺时消耗 |
| 精液槽 | 仅玩家 | 进行射精时消耗 |

#### 2.3.3 特殊状态标记
用 `<>` 符号包裹的状态标记，根据角色当前状态动态显示。
具体状态列表参见 `Script/UI/Panel/character_info_head.py` 中的 `get_character_status_list()` 函数。

#### 2.3.4 快感状态和其他状态
- **快感状态**：从 `data/csv/CharacterState.csv` 中状态类型0获取
- **其他状态**：从 `data/csv/CharacterState.csv` 中状态类型1获取

---

## 3. 核心功能模块

### 3.1 模式切换机制
- Web模式使用专用主面板代码文件 `Script/UI/Panel/in_scene_panel_web.py`
- 非Web模式（tk模式）继续使用原有的 `in_scene_panel.py`
- 模式切换逻辑在 `Script/UI/Flow/normal_flow.py` 中实现

**渲染机制**:
- 所有面板统一使用 `index.html` 模板（单页面应用）
- 主面板通过 `new_ui_container` 元素类型渲染新UI
- 前端根据元素类型自动选择渲染方式

**清屏机制**:
- `clear_screen()`: 清空当前绘制元素，保留历史记录（用于循环内更新）
- `clear_screen_and_history()`: 彻底清空（用于进入主界面）

### 3.2 流式数据传输
- 首次进入主绘制界面时，加载并确定所有内容
- 后续仅根据后端数据变动，对应更新变动的组件部分
- 通过 `_calculate_diff()` 方法计算状态差异实现增量更新

### 3.3 场景背景渲染
- 从 `image/场景/` 路径读取场景图片
- 默认回退图片为 `博士办公室.png`
- 背景图保持原比例缩放，居中显示

---

## 4. 交互系统设计

### 4.1 指令分类
将原有的统一指令栏拆分为两大类：

#### 4.1.1 面板类指令
- **定义**：点击后将游戏画面从主交互面板切换到特定面板的指令
- **显示位置**：画面最上方的选项卡栏
- **显示形式**：选项卡按钮
- **包含内容**：移动、存档、读档、系统设置、查看状态、查看属性、查看关系等

#### 4.1.2 角色交互类指令
- **定义**：对当前交互对象进行各种互动的指令
- **交互流程**：先选择交互类型，然后点击角色（或角色身体部位）进行交互
- **显示位置**：交互类型栏位于画面左侧

### 4.2 角色交互流程

#### 4.2.1 基本流程
1. 玩家在交互类型栏选择一个交互大类（如"手"）
2. 选择该大类下的交互小类（如"抚摸"）
3. 角色图像上显示该小类可用的部位按钮（高亮显示）
4. 玩家点击某个部位
5. 如果只有一个可执行指令，直接执行；否则弹出选项菜单

#### 4.2.2 交互类型按钮行为
- **大类按钮**：点击选择大类，再次点击清空选择
- **小类按钮**：点击选择小类，再次点击清空选择
- **无交互对象时特殊处理**：所有指令统一作为浮现按钮显示

#### 4.2.3 空白区域点击
- 点击空白区域会清空当前交互选择
- 隐藏浮现指令按钮
- 重置身体部位按钮状态

### 4.3 身体部位点击系统

#### 4.3.1 部位按钮状态管理
- **初始状态**（未选择交互类型）：全部位可互动但无高亮
- **选择交互小类后**：可用部位高亮显示，不可用部位禁用状态
- **清空交互选择后**：回到初始状态

#### 4.3.2 臀部子部位高亮映射
臀部（hip）包含多个子部位：小穴、子宫、后穴、尿道、尾巴、胯部。当选择的交互小类有臀部子部位的指令时，臀部按钮也会高亮显示。

#### 4.3.3 头部子部位菜单
点击头部时展开子菜单，包含：头发（始终显示）、兽角（需要角色有兽角特征 talent[112]=1）。

#### 4.3.4 条件部位显示
某些身体部位需要满足特定条件才会显示：
- **兽耳**：作为独立部位显示，分左耳和右耳，需要交互对象有兽耳特征（talent[111]=1）才会显示
- 条件部位在 `CONDITIONAL_BODY_PARTS` 列表中定义
- 后端在 `set_visible_parts()` 时会根据条件过滤

#### 4.3.5 部位按钮特性
- **非直接显示**：默认不显示任何UI效果
- **悬停效果**：鼠标移到部位位置时，光标变为可点击样式并浮现部位名称
- **形状**：以部位中心为圆心的隐形圆形按钮

#### 4.3.6 部位位置数据
- 每个角色的立绘图片配套一个 `{角色名}_body.json` 文件
- JSON内容：每个身体部位的中心位置（归一化坐标）
- 数据由 7模型集成姿态估计工具生成

#### 4.3.7 指令菜单滚动条功能
当指令数量超过8个时，菜单显示滚动条，最大高度400px。

---

## 5. 角色图像系统

### 5.1 图像图层结构
1. **底层 - 身体图层**：角色的基础身体立绘
2. **中间层 - 服装图层**：角色当前穿着的服装
3. **上层 - 特效图层**：表情变化、状态特效等

### 5.2 图像显示规则
- **场景无当前交互对象时**：不显示角色图像，仅显示背景
- **有交互对象时**：全身立绘显示在画面正中央，其他角色以头像形式显示在右上角

### 5.3 图像文件组织
每个角色有单独的文件夹，包含：
- `{角色名}_全身.png` - 全身立绘（web模式使用）
- `{角色名}_半身.png` - 半身图（tk模式使用）
- `{角色名}_头部.png` - 头部图（头像显示使用）
- `{角色名}_body.json` - 身体部位位置数据

### 5.4 双模式兼容
- **tk模式**：读取半身图作为常规立绘使用
- **web模式**：读取全身图作为主立绘使用

### 5.5 角色立绘透明区域裁切
Web模式下会自动裁切角色立绘四周的透明区域，优化显示效果。

- **自动裁切**：加载时自动检测并裁切透明像素区域
- **缓存机制**：裁切后图片存储在内存缓存中（LRU，最多10张）
- **部位按钮同步**：身体部位按钮位置根据裁切元数据自动调整
- **前端缓存**：前端也有图片缓存，切换交互对象时自动清理

### 5.6 身体部位位置调整
裁切会改变图片显示区域，身体部位按钮需要相应调整以保持正确对齐：
- body-parts-layer 尺寸使用像素值，精确匹配图片实际渲染尺寸
- 按钮位置从"相对于原图的百分比"转换为"相对于裁切后图片的百分比"
- 窗口大小变化时自动重新调整

---

## 6. 演出与结算系统

### 6.1 结算阶段概述
执行角色交互类指令后，游戏时间会推进一段时间，在此期间：
- 结算所有角色的行动
- 三种交互方式（选项卡、交互类型栏、部位按钮）均隐藏为不可用
- 结算完成后，交互重新可用

### 6.2 结算显示规则

#### 6.2.1 玩家与交互对象
- **对话显示**：完整对话框形式，显示在画面最下方
- **对话框样式**：半透明背景，左侧角色名字（有交互对象时格式为 `角色名 → 交互对象名`）
- **文本推进**：左键点击推进，按住右键或Ctrl键快速跳过
- **数值变化浮动文本**：对话完毕后显示数值变化，每个数值使用独特颜色，15秒后渐变消失
- **浮动文本位置**：体力/气力/好感/信赖/催眠度显示在数值后面；其他变化在面板底部统一显示

#### 6.2.2 场景内其他角色
- **对话显示**：小型对话框形式，显示在该角色头像下方
- **对话内容**：仅显示行为台词描述的前N个字符
- **数值变化**：不显示
- **无结算时**：如果该时间段内未结算该角色，则不显示任何内容

### 6.3 结算后的头像交互
结算完成后，对于有对话框显示的非交互角色，点击其头像：
1. 将该角色设为当前交互对象
2. 在底部对话框中重新显示完整行为台词
3. 显示该角色的状态数值变化

---

## 7. 指令分类系统

### 7.1 分类定义

#### 7.1.1 指令大类（三类分类系统）

| 分类 | 英文标识 | 触发方式 | 说明 |
|------|---------|---------|------|
| 系统面板类 | `SYSTEM_PANEL` | 点击选项卡按钮 | 函数执行 `cache.now_panel_id = xxx` |
| 角色交互类 | `CHARACTER` | 选择交互类型 → 点击身体部位 | 普通交互，直接执行并结算 |
| 角色交互面板类 | `CHARACTER_PANEL` | 选择交互类型 → 点击身体部位 | 触发后打开临时面板进行选择 |

#### 7.1.2 交互类型（大类/小类）

**交互大类（InteractionMajorType）**：
- MOUTH (嘴)
- HAND (手)
- SEX (性爱)
- PENIS (阴茎)
- TOOL (道具)
- ARTS (技艺)
- OTHER (其他)

**交互小类（InteractionMinorType）**：每个大类下有若干子分类，详见 `Script/System/Instruct_System/interaction_types.py`。

#### 7.1.3 身体部位
基于 `data/csv/BodyPart.csv` 的19个部位 + COCO-WholeBody 17点映射，详见 `Script/System/Instruct_System/instruct_category.py` 中的 `BodyPart` 类。

### 7.2 指令配置方式
- 所有指令配置统一使用 `data/csv/InstructConfig.csv`
- 配置字段包括：`web_major_type`、`web_minor_type`、`body_parts`、`panel_id` 等
- `add_instruct()` 装饰器自动从CSV读取配置

---

## 8. 素材处理流程

### 8.1 角色文件夹构建流程
1. 为每个角色在 `image/立绘/干员/` 或 `image/立绘/特殊NPC/` 下建立同名文件夹
2. 将原始半身图重命名为 `{角色名}_半身.png`
3. 下载全身图命名为 `{角色名}_全身.png`

### 8.2 部位位置数据生成
- **生产工具**：`tools/body_analysis_ensemble.py`（7模型集成批量处理）
- **输出格式**：`{角色名}_body.json`（v2.0格式，model="ensemble"）
- **GPU加速**：支持CUDA加速，RTX 4080下单角色处理约0.26秒
- **手动修正工具**：`tools/body_part_editor.py`（GUI界面，支持拖动修改错误的关键点位置）

### 8.3 tk模式兼容性
- 重命名后的半身图文件名格式为 `{角色名}_半身.png`
- tk模式图片读取逻辑已适配新的文件名格式

### 8.4 最终文件结构
```
image/立绘/干员/{角色名}/
├── {角色名}_全身.png      # 全身立绘（web模式使用）
├── {角色名}_半身.png      # 半身图（tk模式使用）
├── {角色名}_头部.png      # 头部图（头像显示使用）
├── {角色名}_body.json     # 身体部位位置数据
└── ...                    # 其他差分图层
```

---

## 9. 地图渲染系统

### 9.1 地图显示概述
地图使用AA字符画（ASCII Art）形式渲染，需要在Web模式下保持与Tk模式一致的对齐效果。

### 9.2 地图数据结构
- **数据来源**：`data/map/` 目录下的场景JSON文件
- **解析模块**：`Script/Config/map_config.py` 的 `get_print_map_data()` 函数
- **数据结构**：`MapDraw` 类，包含多行 `MapDrawLine`，每行包含多个绘制对象

### 9.3 Web模式特殊处理

#### 9.3.1 后端预处理
1. **行尾空格移除**：在解析时调用 `_trim_map_line_trailing_spaces()` 移除行尾空格
2. **行首空格规范化**：调用 `_normalize_map_leading_spaces()` 统一行首空格
3. **最大宽度计算**：使用 `text_handle.get_text_index()` 统一计算显示宽度，存储在 `MapDraw.max_width`
4. **居中偏移计算**：`see_map_panel.py` 使用 `max_width` 计算统一的居中偏移

#### 9.3.2 前端渲染
1. **元素分类**：地图行使用 `map-line` CSS类标识
2. **分组处理**：`normalizeMapBlocks()` 函数将连续的 `map-line` 元素分组
3. **宽度同步**：计算组内所有行的最大像素宽度，为每行设置 `min-width` 统一宽度
4. **居中显示**：使用 `map-group` 和 `map-group-inner` 容器实现整体居中

#### 9.3.3 分组逻辑
- 地图行之间可能存在换行元素（`text-break`、空div等）
- 分组时忽略这些换行元素，确保连续的地图行被正确分组
- 只有遇到有实际内容的非地图元素时才中断当前组

### 9.4 CSS样式要点
```css
.map-line {
    display: block;
    width: max-content;
    white-space: pre;
    font-family: 'SarasaMonoSC', monospace;
    margin: auto;
    font-kerning: none;           /* 禁用字距调整 */
    font-variant-ligatures: none; /* 禁用连字 */
    text-align: left;             /* 文本内容左对齐 */
}

.map-group {
    display: block;
    width: 100%;
    text-align: center;
}

.map-group-inner {
    display: inline-block;
    text-align: left;
}
```

### 9.5 常见问题与解决

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 各行起点不对齐 | 行首空格数量不同 | `_normalize_map_leading_spaces()` 规范化 |
| Emoji宽度异常 | Python与浏览器字符宽度计算差异 | 前端JS统一设置 `min-width` |
| 行间断开分组 | 换行元素中断分组 | 分组时忽略换行/空元素 |

---

## 10. 文件结构规划

### 10.1 后端代码文件
```
Script/UI/Panel/
├── in_scene_panel.py           # tk模式主面板
├── in_scene_panel_web.py       # web模式主面板

Script/System/Web_Draw_System/  # web专用组件目录
├── __init__.py
├── scene_renderer.py       # 场景背景渲染
├── character_renderer.py   # 角色图像渲染
├── interaction_handler.py  # 交互处理
├── dialog_box.py           # 对话框
├── status_panel.py         # 状态面板
├── tab_menu.py             # 选项卡菜单
├── body_part_button.py     # 身体部位按钮
├── settlement_manager.py   # 结算管理
└── image_processor.py      # 图片处理（裁切）

Script/System/Instruct_System/
├── instruct_category.py        # 指令分类枚举
├── instruct_meta.py            # 指令元数据管理
└── interaction_types.py        # 交互类型定义
```

### 10.2 前端文件
```
templates/
└── index.html                  # 统一页面模板

static/
├── game.js                     # 主游戏逻辑
├── style.css                   # 样式文件
└── js/
    ├── game_renderer.js        # 画面渲染器
    ├── interaction_manager.js  # 交互管理器
    ├── ui_components.js        # UI组件库
    └── websocket_handler.js    # WebSocket处理
```

### 10.3 素材处理工具
```
tools/
├── build_character_folders.py        # 构建角色文件夹结构
├── rename_and_organize_images.py     # 重命名和整理图片
├── body_analysis_ensemble.py         # 7模型集成批量处理（生产使用）
├── body_analysis_multi_compare.py    # 7模型+集成对比工具
└── body_part_editor.py               # 身体部位数据手动编辑工具（GUI）
```

### 10.4 素材目录结构
```
image/
├── 场景/                       # 场景背景图
│   └── *.png
├── 立绘/
│   ├── 干员/
│   │   └── {角色名}/
│   │       ├── {角色名}_全身.png
│   │       ├── {角色名}_半身.png
│   │       ├── {角色名}_头部.png
│   │       └── {角色名}_body.json
│   └── 特殊NPC/
│       └── ...
└── 状态条/                     # 状态条图片资源
    └── *.png
```

---

## 附录：术语说明

| 术语 | 说明 |
|------|------|
| tk模式 | 基于Tkinter的原有文本界面模式 |
| web模式 | 基于网页的新图形界面模式 |
| 交互类型 | 对角色进行互动的类别（说话、抚摸、亲吻等） |
| 部位按钮 | 角色立绘上的隐形可点击区域 |
| 面板类指令 | 点击后切换显示面板的指令 |
| 角色交互类指令 | 对角色进行互动的指令 |
| 结算阶段 | 执行指令后的时间推进和行动结算过程 |
| 流式传输 | 仅传输变动数据以提升性能的方式 |
| 全身图 | 从头到脚的完整角色立绘（web模式使用） |
| 半身图 | 上半身角色立绘（tk模式使用） |
| 头部图 | 角色头部图片（用于头像区显示） |
| 特殊状态标记 | 用`<>`符号包裹的各种状态标识 |
